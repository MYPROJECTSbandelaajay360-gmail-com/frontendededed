{% extends 'bakery/driver_base.html' %}

{% block title %}Orders - Driver Panel{% endblock %}

{% block extra_css %}
<style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DRIVER ORDERS â€” Professional Redesign
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .page-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 20px; flex-wrap: wrap; gap: 12px;
    }
    .page-header h1 { font-size: 22px; font-weight: 800; color: var(--text); }
    .orders-count {
        font-size: 13px; color: var(--text-secondary); font-weight: 500;
        background: var(--card); padding: 6px 16px; border-radius: 20px;
        border: 1px solid var(--border);
    }

    /* Search */
    .search-bar {
        display: flex; gap: 10px; margin-bottom: 20px;
    }
    .search-input {
        flex: 1; padding: 10px 16px 10px 40px; border: 1px solid var(--border);
        border-radius: var(--radius-sm); font-size: 14px; font-family: inherit;
        background: var(--card) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%2394a3b8' viewBox='0 0 24 24' width='18' height='18'%3E%3Cpath d='M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E") no-repeat 12px center;
        transition: var(--transition);
    }
    .search-input:focus {
        outline: none; border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(232,89,12,0.1);
    }

    /* Filter Tabs */
    .filter-tabs {
        display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap;
    }
    .filter-tab {
        padding: 8px 18px; border-radius: 20px; border: 1px solid var(--border);
        background: var(--card); color: var(--text-secondary); font-size: 13px;
        font-weight: 600; cursor: pointer; text-decoration: none;
        transition: var(--transition);
    }
    .filter-tab:hover {
        border-color: var(--primary); color: var(--primary);
    }
    .filter-tab.active {
        background: var(--primary); color: #fff; border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(232,89,12,0.3);
    }
    .filter-tab .tab-count {
        display: inline-block; background: rgba(255,255,255,0.2);
        padding: 1px 8px; border-radius: 10px; font-size: 11px; margin-left: 4px;
    }

    /* Order Card */
    .order-card {
        margin-bottom: 16px; padding: 20px; background: var(--card);
        border-radius: var(--radius); box-shadow: var(--shadow);
        border: 1px solid var(--border); transition: var(--transition);
    }
    .order-card:hover {
        box-shadow: var(--shadow-md); transform: translateY(-2px);
    }
    .order-card.unassigned { border-left: 4px solid #f59e0b; }

    .order-top {
        display: flex; justify-content: space-between; align-items: flex-start;
        margin-bottom: 14px;
    }
    .order-id { font-weight: 700; font-size: 15px; color: var(--text); }
    .order-time { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
    .order-amount { font-weight: 800; font-size: 20px; color: var(--primary); }

    /* Status Pill */
    .status-pill {
        display: inline-flex; align-items: center; gap: 5px;
        padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;
    }
    .status-pill.confirmed { background: var(--info-bg); color: var(--info); }
    .status-pill.preparing { background: #fef3c7; color: #d97706; }
    .status-pill.ready { background: #dbeafe; color: #2563eb; }
    .status-pill.picked_up { background: var(--warning-bg); color: var(--warning); }
    .status-pill.on_the_way { background: #e0e7ff; color: #4f46e5; }
    .status-pill.delivered, .status-pill.completed {
        background: var(--success-bg); color: var(--success);
    }
    .status-pill.cancelled { background: var(--danger-bg); color: var(--danger); }

    /* Info Box */
    .order-info {
        background: #f8fafc; border-radius: var(--radius-sm); padding: 14px;
        margin-bottom: 14px; border: 1px solid var(--border);
    }
    .info-row {
        display: flex; align-items: flex-start; gap: 10px;
        font-size: 13px; margin-bottom: 8px;
    }
    .info-row:last-child { margin-bottom: 0; }
    .info-row i { color: var(--primary); margin-top: 3px; width: 16px; text-align: center; }
    .info-row .val { font-weight: 600; color: var(--text); flex: 1; line-height: 1.4; }

    /* Items List */
    .order-items {
        border: 1px solid var(--border); border-radius: var(--radius-sm);
        padding: 14px; margin-bottom: 14px;
    }
    .order-items-title {
        font-weight: 700; font-size: 12px; color: var(--text-secondary);
        text-transform: uppercase; letter-spacing: 0.5px;
        margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border);
    }
    .item-row {
        display: flex; align-items: center; gap: 12px; padding: 8px 0;
        border-bottom: 1px dashed var(--border);
    }
    .item-row:last-child { border-bottom: none; padding-bottom: 0; }
    .item-img {
        width: 42px; height: 42px; border-radius: 8px; object-fit: cover;
        border: 1px solid var(--border);
    }
    .item-placeholder {
        width: 42px; height: 42px; border-radius: 8px; background: #f1f5f9;
        display: flex; align-items: center; justify-content: center;
        color: #94a3b8; font-size: 16px; border: 1px solid var(--border);
    }
    .item-details { flex: 1; }
    .item-name { font-weight: 600; font-size: 13px; color: var(--text); }
    .item-meta { font-size: 11px; color: var(--text-secondary); }
    .item-price { font-weight: 700; font-size: 13px; color: var(--primary); }

    /* Action Buttons */
    .order-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn-action {
        padding: 8px 16px; border-radius: var(--radius-sm); font-size: 13px;
        font-weight: 600; border: none; cursor: pointer; display: inline-flex;
        align-items: center; gap: 6px; transition: var(--transition); text-decoration: none;
    }
    .btn-action.primary { background: var(--primary); color: #fff; }
    .btn-action.primary:hover { background: var(--primary-dark); }
    .btn-action.success { background: var(--success); color: #fff; }
    .btn-action.success:hover { background: #15803d; }
    .btn-action.outline {
        background: transparent; color: var(--text-secondary);
        border: 1px solid var(--border);
    }
    .btn-action.outline:hover { border-color: var(--primary); color: var(--primary); }

    /* Empty State */
    .empty-state {
        padding: 60px 20px; text-align: center; background: var(--card);
        border-radius: var(--radius); border: 1px solid var(--border);
    }
    .empty-state .icon { font-size: 52px; margin-bottom: 16px; }
    .empty-state h3 { font-weight: 700; margin-bottom: 6px; }
    .empty-state p { color: var(--text-secondary); font-size: 14px; }

    /* Section Divider */
    .section-title {
        font-size: 15px; font-weight: 700; margin-bottom: 14px;
        display: flex; align-items: center; gap: 8px; color: var(--text);
    }
    .section-title i { color: var(--primary); }
    .section-title .count {
        background: #fef3c7; color: #d97706; font-size: 12px; font-weight: 700;
        padding: 2px 10px; border-radius: 20px; margin-left: 6px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h1><i class="fas fa-clipboard-list" style="color:var(--primary);margin-right:8px;"></i> My Orders</h1>
    <div class="orders-count">{{ orders|length }} order{{ orders|length|pluralize:"s" }} found</div>
</div>

<!-- Search Bar -->
<div class="search-bar">
    <input type="text" class="search-input" id="searchInput"
        placeholder="Search by order ID, customer name..."
        oninput="filterOrders()">
</div>

<!-- Filter Tabs -->
<div class="filter-tabs">
    <a href="?status=all" class="filter-tab {% if status_filter == 'all' %}active{% endif %}">
        <i class="fas fa-list"></i> All
    </a>
    <a href="?status=confirmed" class="filter-tab {% if status_filter == 'confirmed' %}active{% endif %}">
        <i class="fas fa-check"></i> Assigned
    </a>
    <a href="?status=preparing" class="filter-tab {% if status_filter == 'preparing' %}active{% endif %}">
        <i class="fas fa-fire"></i> Preparing
    </a>
    <a href="?status=ready" class="filter-tab {% if status_filter == 'ready' %}active{% endif %}">
        <i class="fas fa-box"></i> Ready
    </a>
    <a href="?status=picked_up" class="filter-tab {% if status_filter == 'picked_up' %}active{% endif %}">
        <i class="fas fa-motorcycle"></i> Picked Up
    </a>
    <a href="?status=on_the_way" class="filter-tab {% if status_filter == 'on_the_way' %}active{% endif %}">
        <i class="fas fa-route"></i> En Route
    </a>
    <a href="?status=delivered" class="filter-tab {% if status_filter == 'delivered' %}active{% endif %}">
        <i class="fas fa-check-double"></i> Delivered
    </a>
</div>

<!-- Available for Pickup (Unassigned) -->
{% if unassigned_orders %}
<div class="section-title" style="margin-bottom:14px;">
    <i class="fas fa-inbox"></i> Available for Pickup
    <span class="count">{{ unassigned_orders|length }}</span>
</div>

{% for order in unassigned_orders %}
<div class="order-card unassigned"
     data-search="{{ order.order_id }} {{ order.user.first_name }} {{ order.user.last_name }} {{ order.user.username }}">
    <div class="order-top">
        <div>
            <div class="order-id">Order #{{ order.id }}</div>
            <div class="order-time"><i class="fas fa-clock"></i> {{ order.created_at|timesince }} ago</div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
            <span class="status-pill {{ order.status }}">{{ order.get_status_display }}</span>
            <div class="order-amount">â‚¹{{ order.grand_total }}</div>
        </div>
    </div>
    <div class="order-info">
        <div class="info-row">
            <i class="fas fa-user"></i>
            <div class="val">{{ order.user.first_name|default:order.user.username }} {{ order.user.last_name|default:"" }}</div>
        </div>
        <div class="info-row">
            <i class="fas fa-phone-alt"></i>
            <div class="val">{{ order.delivery_phone|default:"N/A" }}</div>
        </div>
        <div class="info-row">
            <i class="fas fa-map-marker-alt"></i>
            <div class="val">{{ order.delivery_address|default:"Not provided" }}</div>
        </div>
    </div>
    <div class="order-items">
        <div class="order-items-title">Order Items ({{ order.items.count }})</div>
        {% for item in order.items.all %}
        <div class="item-row">
            {% if item.menu_item.image_url %}
            <img src="{{ item.menu_item.image_url }}" alt="{{ item.menu_item.name }}" class="item-img">
            {% else %}
            <div class="item-placeholder"><i class="fas fa-utensils"></i></div>
            {% endif %}
            <div class="item-details">
                <div class="item-name">{{ item.menu_item.name }}</div>
                <div class="item-meta">{{ item.quantity }} Ã— â‚¹{{ item.price }}</div>
            </div>
            <div class="item-price">â‚¹{{ item.subtotal }}</div>
        </div>
        {% endfor %}
    </div>
    <div class="order-actions">
        <button class="btn-action primary" onclick="updateOrderStatus('{{ order.order_id }}', 'accept')">
            <i class="fas fa-check"></i> Accept Delivery
        </button>
    </div>
</div>
{% endfor %}

<div style="border-bottom:2px solid var(--border);margin:24px 0;"></div>
{% endif %}

<!-- My Orders -->
{% if orders %}
<div class="section-title">
    <i class="fas fa-truck"></i> My Deliveries
</div>

{% for order in orders %}
<div class="order-card"
     data-search="{{ order.order_id }} {{ order.user.first_name }} {{ order.user.last_name }} {{ order.user.username }}">
    <div class="order-top">
        <div>
            <div class="order-id">Order #{{ order.id }}</div>
            <div class="order-time"><i class="fas fa-clock"></i> {{ order.created_at|timesince }} ago</div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
            <span class="status-pill {{ order.status }}">
                {% if order.status == 'confirmed' %}<i class="fas fa-check"></i>
                {% elif order.status == 'preparing' %}<i class="fas fa-fire"></i>
                {% elif order.status == 'ready' %}<i class="fas fa-box"></i>
                {% elif order.status == 'picked_up' %}<i class="fas fa-motorcycle"></i>
                {% elif order.status == 'on_the_way' %}<i class="fas fa-route"></i>
                {% elif order.status == 'delivered' or order.status == 'completed' %}<i class="fas fa-check-double"></i>
                {% endif %}
                {{ order.get_status_display }}
            </span>
            <div class="order-amount">â‚¹{{ order.grand_total }}</div>
        </div>
    </div>
    <div class="order-info">
        <div class="info-row">
            <i class="fas fa-user"></i>
            <div class="val">{{ order.user.first_name|default:order.user.username }} {{ order.user.last_name|default:"" }}</div>
        </div>
        <div class="info-row">
            <i class="fas fa-phone-alt"></i>
            <div class="val">{{ order.delivery_phone|default:"N/A" }}</div>
        </div>
        <div class="info-row">
            <i class="fas fa-map-marker-alt"></i>
            <div class="val">{{ order.delivery_address|default:"Not provided" }}</div>
        </div>
        <div class="info-row">
            <i class="fas fa-rupee-sign"></i>
            <div class="val">Delivery Fee: â‚¹{{ order.delivery_fee }} &middot; Total: â‚¹{{ order.grand_total }}</div>
        </div>
        {% if order.delivery_notes %}
        <div class="info-row">
            <i class="fas fa-sticky-note"></i>
            <div class="val" style="color:var(--text-secondary);font-style:italic;">{{ order.delivery_notes }}</div>
        </div>
        {% endif %}
    </div>
    <div class="order-items">
        <div class="order-items-title">Order Items ({{ order.items.count }})</div>
        {% for item in order.items.all %}
        <div class="item-row">
            {% if item.menu_item.image_url %}
            <img src="{{ item.menu_item.image_url }}" alt="{{ item.menu_item.name }}" class="item-img">
            {% else %}
            <div class="item-placeholder"><i class="fas fa-utensils"></i></div>
            {% endif %}
            <div class="item-details">
                <div class="item-name">{{ item.menu_item.name }}</div>
                <div class="item-meta">{{ item.quantity }} Ã— â‚¹{{ item.price }}</div>
            </div>
            <div class="item-price">â‚¹{{ item.subtotal }}</div>
        </div>
        {% endfor %}
    </div>
    <div class="order-actions">
        {% if order.status == 'confirmed' or order.status == 'preparing' or order.status == 'ready' %}
        <button class="btn-action primary" onclick="updateOrderStatus('{{ order.order_id }}', 'pickup')">
            <i class="fas fa-motorcycle"></i> Mark Picked Up
        </button>
        {% elif order.status == 'picked_up' %}
        <button class="btn-action primary" onclick="updateOrderStatus('{{ order.order_id }}', 'on_the_way')">
            <i class="fas fa-route"></i> Start Delivery
        </button>
        {% elif order.status == 'on_the_way' %}
        <button class="btn-action success" onclick="updateOrderStatus('{{ order.order_id }}', 'delivered')">
            <i class="fas fa-check-double"></i> Mark Delivered
        </button>
        {% elif order.status == 'delivered' or order.status == 'completed' %}
        <span class="btn-action" style="color:var(--success);cursor:default;">
            <i class="fas fa-check-circle"></i> Delivered
        </span>
        {% endif %}
        {% if order.delivery_phone %}
        <a href="tel:{{ order.delivery_phone }}" class="btn-action outline"><i class="fas fa-phone"></i> Call</a>
        {% endif %}
        <a href="{% url 'driver_map' %}" class="btn-action outline"><i class="fas fa-map-marker-alt"></i> Map</a>
    </div>
</div>
{% endfor %}

{% else %}
<div class="empty-state">
    <div class="icon">ğŸ“‹</div>
    <h3>No Orders Found</h3>
    <p>
        {% if status_filter != 'all' %}
        No orders with this status.
        <a href="?status=all" style="color:var(--primary);font-weight:600;">View all orders</a>
        {% else %}
        You don't have any orders yet. Available deliveries will show above.
        {% endif %}
    </p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    function filterOrders() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.order-card').forEach(card => {
            const text = (card.dataset.search || '').toLowerCase();
            card.style.display = text.includes(query) ? '' : 'none';
        });
    }
</script>
{% endblock %}
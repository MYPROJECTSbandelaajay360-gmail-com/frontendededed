{% extends 'bakery/base.html' %}

{% block content %}
<style>
    .payment-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
    }

    .payment-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .order-summary {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 25px;
    }

    .order-summary h3 {
        color: #d2691e;
        margin-bottom: 15px;
        font-size: 18px;
    }

    .order-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .order-item:last-child {
        border-bottom: none;
    }

    .order-total {
        display: flex;
        justify-content: space-between;
        padding: 15px 0;
        margin-top: 10px;
        border-top: 2px solid #d2691e;
        font-weight: bold;
        font-size: 18px;
        color: #d2691e;
    }

    .payment-method {
        margin: 25px 0;
    }

    .payment-method h3 {
        margin-bottom: 15px;
    }

    .payment-method input[type="radio"] {
        display: none;
    }

    .payment-method label {
        display: block;
        padding: 15px 20px;
        margin: 10px 0;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .payment-method label i {
        font-size: 24px;
        color: #d2691e;
    }

    .payment-method input[type="radio"]:checked+label {
        border-color: #d2691e;
        background: #fff5ee;
    }

    .payment-details {
        display: none;
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .payment-details.active {
        display: block;
    }

    .payment-details h4 {
        color: #d2691e;
        margin-bottom: 15px;
    }

    .payment-input {
        width: 100%;
        padding: 12px 15px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
    }

    .payment-input:focus {
        outline: none;
        border-color: #d2691e;
    }

    .pay-button {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #d2691e, #8b4513);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 20px;
    }

    .pay-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(210, 105, 30, 0.3);
    }

    .pay-button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
</style>
<div class="payment-container">
    <div class="payment-card">
        {% csrf_token %}
        <h2 style="color: #d2691e; margin-bottom: 20px;">
            Complete Your Payment
        </h2>

        <!-- Order Summary -->
        <div class="order-summary">
            <h3>Order Summary</h3>
            <div id="orderItems"></div>
            <div class="order-item">
                <span>Subtotal:</span>
                <span id="subtotal">₹0.00</span>
            </div>
            <div class="order-item">
                <span>Delivery Fee:</span>
                <span id="deliveryFee">₹50.00</span>
            </div>
            <div class="order-total">
                <span>Total Amount:</span>
                <span id="totalAmount">₹0.00</span>
            </div>
        </div>

        <!-- Order Type Selection -->
        <div class="payment-method">
            <h3 style="color: #d2691e; margin-bottom: 15px;">Choose Delivery Option</h3>

            <input type="radio" name="order_type" id="delivery" value="delivery" checked>
            <label for="delivery">
                <i class="ri-truck-line"></i> Home Delivery
            </label>

            <input type="radio" name="order_type" id="takeaway" value="takeaway">
            <label for="takeaway">
                <i class="ri-store-2-line"></i> Pickup at Store
            </label>
        </div>

        <!-- Delivery/Pickup Details Form -->
        <div id="deliveryDetailsSection" style="margin: 25px 0;">
            <h3 id="detailsTitle" style="color: #d2691e; margin-bottom: 15px;">Delivery Details</h3>
            <div id="addressGroup">
                <input type="text" class="payment-input" id="deliveryAddress" placeholder="Delivery Address *" required>
            </div>
            <div id="storeAddressGroup"
                style="display: none; padding: 15px; background: #fff5ee; border-radius: 10px; border: 1px solid #d2691e; margin-bottom: 15px;">
                <p style="color: #d2691e; font-weight: bold; margin-bottom: 5px;"><i class="ri-map-pin-line"></i> Store
                    Address:</p>
                <p style="color: #8b4513;">Hno:12-13-123/4, 3rd floor,Near max store , Chaitanyapuri , Hyderabad </p>
            </div>
            <input type="tel" class="payment-input" id="deliveryPhone" placeholder="Phone Number *" required>
            <textarea class="payment-input" id="deliveryNotes" placeholder="Additional Notes (Optional)"
                rows="3"></textarea>
        </div>

        <!-- Pay Button -->
        <button class="pay-button" id="payButton" type="button">
            Pay with Razorpay
        </button>
    </div>

    <!-- Payment Success Message -->
    <!-- <div class="payment-success" id="paymentSuccess">
            <i class="ri-checkbox-circle-fill"></i>
            <h2>Payment Successful!</h2>
            <p>Your payment has been verified and processed successfully.</p>
            <p><strong>Order ID:</strong> <span id="successOrderId"></span></p>
            <p><strong>Transaction ID:</strong> <span id="successTransactionId"></span></p>
            <button class="pay-button" style="margin-top: 20px; max-width: 300px; margin-left: auto; margin-right: auto;" 
                    onclick="window.location.href='/html/orders.html'">
                View My Orders
            </button>
        </div> -->
</div>

{% endblock %}

{% block extra_js %}
<script>
    function updateCartDisplay() {
        const cartData = JSON.parse(localStorage.getItem('bakeryCart')) || {};
        const totalQuantity = Object.values(cartData).reduce((sum, item) => sum + item.quantity, 0);
        const totalPrice = Object.values(cartData).reduce((sum, item) => sum + (item.price * item.quantity), 0);

        const navQuantity = document.querySelector('#quantity');
        const cartPrice = document.querySelector('#cart_price');

        if (navQuantity) navQuantity.textContent = totalQuantity;
        if (cartPrice) cartPrice.textContent = `₹${totalPrice.toFixed(2)}`;
    }

    // Load cart display when page loads
    document.addEventListener('DOMContentLoaded', updateCartDisplay);

    // Function to format numbers as currency

    function formatCurrency(amount) {
        return `₹${amount.toFixed(2)}`;
    }

    // Function to load order summary from localStorage
    // Function to load order summary from localStorage
    function loadOrderSummary() {
        const cartData = JSON.parse(localStorage.getItem('bakeryCart')) || {};
        const orderItemsContainer = document.getElementById('orderItems');
        const subtotalElem = document.getElementById('subtotal');
        const deliveryFeeElem = document.getElementById('deliveryFee');
        const totalAmountElem = document.getElementById('totalAmount');

        orderItemsContainer.innerHTML = '';
        let subtotal = 0;

        Object.entries(cartData).forEach(([itemName, item]) => {
            const itemTotal = item.price * item.quantity;
            subtotal += itemTotal;

            const itemDiv = document.createElement('div');
            itemDiv.className = 'order-item';
            itemDiv.innerHTML = `
                <span>${itemName} x ${item.quantity}</span>
                <span>${formatCurrency(itemTotal)}</span>
            `;
            orderItemsContainer.appendChild(itemDiv);
        });

        // Calculate delivery fee based on selected order type
        const orderType = document.querySelector('input[name="order_type"]:checked').value;
        const deliveryFee = orderType === 'delivery' ? 50.00 : 0.00;
        const totalAmount = subtotal + deliveryFee;

        subtotalElem.textContent = formatCurrency(subtotal);
        deliveryFeeElem.textContent = formatCurrency(deliveryFee);
        totalAmountElem.textContent = formatCurrency(totalAmount);
    }

    // Update cart display in navigation
    function updateCartDisplay() {
        const cartData = JSON.parse(localStorage.getItem('bakeryCart')) || {};
        const totalQuantity = Object.values(cartData).reduce((sum, item) => sum + item.quantity, 0);
        const totalPrice = Object.values(cartData).reduce((sum, item) => sum + (item.price * item.quantity), 0);

        const navQuantity = document.querySelector('#quantity');
        const cartPrice = document.querySelector('#cart_price');

        if (navQuantity) navQuantity.textContent = totalQuantity;
        if (cartPrice) cartPrice.textContent = `₹${totalPrice.toFixed(2)}`;
    }

    // Function to handle order type selection
    function handleOrderTypeChange() {
        const orderTypes = document.getElementsByName('order_type');
        const addressGroup = document.getElementById('addressGroup');
        const storeAddressGroup = document.getElementById('storeAddressGroup');
        const detailsTitle = document.getElementById('detailsTitle');
        const deliveryAddress = document.getElementById('deliveryAddress');

        orderTypes.forEach(type => {
            type.addEventListener('change', () => {
                if (type.value === 'delivery') {
                    addressGroup.style.display = 'block';
                    storeAddressGroup.style.display = 'none';
                    detailsTitle.textContent = 'Delivery Details';
                    deliveryAddress.required = true;
                } else {
                    addressGroup.style.display = 'none';
                    storeAddressGroup.style.display = 'block';
                    detailsTitle.textContent = 'Pickup Details';
                    deliveryAddress.required = false;
                }
                loadOrderSummary();
            });
        });
    }

    // Function to handle payment processing
    function processPayment() {
        console.log('Payment button clicked!');

        const orderType = document.querySelector('input[name="order_type"]:checked').value;
        const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
        const deliveryPhone = document.getElementById('deliveryPhone').value.trim();
        const deliveryNotes = document.getElementById('deliveryNotes').value.trim();

        console.log('Order Details:', { orderType, deliveryAddress, deliveryPhone, deliveryNotes });

        // Validate delivery details
        if (orderType === 'delivery' && !deliveryAddress) {
            alert('Please fill in your delivery address');
            return;
        }
        if (!deliveryPhone) {
            alert('Please fill in your phone number');
            return;
        }

        // Get cart data
        const cartData = JSON.parse(localStorage.getItem('bakeryCart')) || {};
        if (Object.keys(cartData).length === 0) {
            alert('Your cart is empty!');
            window.location.href = "{% url 'menu' %}";
            return;
        }

        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{% url 'payment' %}";

        // Add CSRF token
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfTokenElement) {
            alert('CSRF token not found! Please refresh the page.');
            return;
        }

        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfTokenElement.value;
        form.appendChild(csrfInput);

        // Add order type
        const typeInput = document.createElement('input');
        typeInput.type = 'hidden';
        typeInput.name = 'order_type';
        typeInput.value = orderType;
        form.appendChild(typeInput);

        // Add cart data
        const cartInput = document.createElement('input');
        cartInput.type = 'hidden';
        cartInput.name = 'cart_data';
        cartInput.value = JSON.stringify(cartData);
        form.appendChild(cartInput);

        // Add delivery details
        const addressInput = document.createElement('input');
        addressInput.type = 'hidden';
        addressInput.name = 'delivery_address';
        addressInput.value = orderType === 'delivery' ? deliveryAddress : 'Store Pickup';
        form.appendChild(addressInput);

        const phoneInput = document.createElement('input');
        phoneInput.type = 'hidden';
        phoneInput.name = 'delivery_phone';
        phoneInput.value = deliveryPhone;
        form.appendChild(phoneInput);

        const notesInput = document.createElement('input');
        notesInput.type = 'hidden';
        notesInput.name = 'delivery_notes';
        notesInput.value = deliveryNotes;
        form.appendChild(notesInput);

        // Submit form
        document.body.appendChild(form);
        form.submit();
    }

    // Initialize everything when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        loadOrderSummary();
        handleOrderTypeChange();
        updateCartDisplay();

        // Add click event to pay button
        const payButton = document.getElementById('payButton');
        if (payButton) {
            payButton.addEventListener('click', processPayment);
        }
    });

</script>
{% endblock %}
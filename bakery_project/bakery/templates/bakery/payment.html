{% extends 'bakery/base.html' %}

{% block content %}
<style>
    .payment-container {
        max-width: 820px;
        margin: 36px auto;
        padding: 0 16px 60px;
    }
    .payment-card {
        background: white;
        border-radius: 18px;
        padding: 30px 32px;
        box-shadow: 0 4px 24px rgba(0,0,0,.09);
    }
    .pay-title {
        color: #d2691e;
        font-size: 22px;
        font-weight: 800;
        margin-bottom: 24px;
    }

    /* ── Order Summary ── */
    .order-summary {
        background: #fdf8f4;
        padding: 18px 20px;
        border-radius: 12px;
        margin-bottom: 24px;
        border: 1px solid #f0ddd0;
    }
    .order-summary h3 { color: #d2691e; margin-bottom: 12px; font-size: 16px; }
    .order-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0e0cc;
        font-size: 14px;
    }
    .order-item:last-child { border-bottom: none; }
    .order-total {
        display: flex;
        justify-content: space-between;
        padding-top: 12px;
        margin-top: 8px;
        border-top: 2px solid #d2691e;
        font-weight: 700;
        font-size: 17px;
        color: #d2691e;
    }

    /* ── Delivery Toggle ── */
    .delivery-toggle {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 24px;
    }
    .delivery-toggle input[type="radio"] { display: none; }
    .delivery-toggle label {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 14px 18px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: #555;
        transition: all .2s;
    }
    .delivery-toggle label i { font-size: 20px; color: #d2691e; }
    .delivery-toggle input[type="radio"]:checked + label {
        border-color: #d2691e;
        background: #fff5ee;
        color: #d2691e;
    }

    /* ── Section Titles ── */
    .section-label {
        font-size: 15px;
        font-weight: 700;
        color: #333;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .section-label i { color: #d2691e; }

    /* ── Saved Addresses (chips) ── */
    #savedAddressesArea { margin-bottom: 18px; }
    .saved-addr-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 8px;
    }
    .saved-addr-chip {
        border: 2px solid #e8ddd0;
        border-radius: 12px;
        padding: 12px 14px;
        cursor: pointer;
        transition: all .2s;
        position: relative;
        background: white;
    }
    .saved-addr-chip:hover { border-color: #d2691e; background: #fdf6ee; }
    .saved-addr-chip.selected { border-color: #d2691e; background: #fff5ee; }
    .chip-label {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: .5px;
        color: #d2691e;
        margin-bottom: 3px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .chip-label i { font-size: 11px; }
    .chip-address {
        font-size: 12px;
        color: #555;
        line-height: 1.4;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }
    .chip-delete {
        position: absolute;
        top: 6px; right: 8px;
        font-size: 14px;
        color: #ccc;
        cursor: pointer;
        line-height: 1;
        z-index: 1;
    }
    .chip-delete:hover { color: #e53935; }
    .add-new-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        color: #d2691e;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        padding: 8px 0;
        text-decoration: none;
    }
    .addr-limit-msg {
        font-size: 12px;
        color: #f97316;
        background: #fff7ed;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #fed7aa;
    }

    /* ── Map Picker ── */
    .map-picker-section { margin-bottom: 18px; }
    .locate-btns {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    .locate-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 7px;
        padding: 11px;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: 2px solid #d2691e;
        transition: all .2s;
        background: white;
        color: #d2691e;
    }
    .locate-btn:hover, .locate-btn.primary-btn { background: #d2691e; color: white; }
    .locate-btn i { font-size: 15px; }

    .map-box {
        width: 100%;
        height: 240px;
        border-radius: 14px;
        overflow: hidden;
        border: 2px solid #e8ddd0;
        position: relative;
        display: none;
    }
    .map-box.visible { display: block; }
    #addrPickerMap { width: 100%; height: 100%; }
    .map-pin-overlay {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -110%);
        font-size: 32px;
        pointer-events: none;
        z-index: 5;
        filter: drop-shadow(0 3px 4px rgba(0,0,0,.3));
    }

    /* ── Address Form ── */
    #addressFormSection { display: none; }
    #addressFormSection.visible { display: block; }

    .addr-form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    @media (max-width: 600px) { .addr-form-grid { grid-template-columns: 1fr; } }
    .addr-form-grid .span2 { grid-column: span 2; }

    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group label {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: .5px;
        color: #888;
    }
    .form-group label span { color: #e53935; }
    .form-input {
        padding: 11px 14px;
        border: 2px solid #e8ddd0;
        border-radius: 10px;
        font-size: 14px;
        transition: border-color .2s;
        width: 100%;
        outline: none;
        background: white;
    }
    .form-input:focus { border-color: #d2691e; }
    .form-input.error { border-color: #e53935; background: #fff5f5; }

    /* Address type selector */
    .addr-type-row {
        display: flex;
        gap: 8px;
        margin-top: 4px;
    }
    .addr-type-btn {
        flex: 1;
        padding: 9px 6px;
        border: 2px solid #e8ddd0;
        border-radius: 10px;
        text-align: center;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        color: #888;
        transition: all .2s;
        background: white;
    }
    .addr-type-btn i { display: block; font-size: 16px; margin-bottom: 2px; }
    .addr-type-btn.selected { border-color: #d2691e; background: #fff5ee; color: #d2691e; }

    /* Save address toggle */
    .save-toggle-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 14px;
        padding: 12px 14px;
        background: #fdf6ee;
        border-radius: 10px;
        border: 1px solid #f0ddd0;
    }
    .save-toggle-row label { font-size: 13px; font-weight: 600; color: #333; cursor: pointer; flex: 1; }
    .toggle-switch { position: relative; width: 40px; height: 22px; flex-shrink: 0; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
        position: absolute; inset: 0;
        background: #ccc; border-radius: 22px; cursor: pointer;
        transition: .3s;
    }
    .toggle-slider::before {
        content: '';
        position: absolute;
        width: 16px; height: 16px;
        left: 3px; bottom: 3px;
        background: white; border-radius: 50%;
        transition: .3s;
    }
    input:checked + .toggle-slider { background: #d2691e; }
    input:checked + .toggle-slider::before { transform: translateX(18px); }

    /* Selected address display */
    .selected-addr-display {
        display: none;
        padding: 14px 16px;
        background: #f0fdf4;
        border: 2px solid #4caf50;
        border-radius: 12px;
        margin-bottom: 14px;
        font-size: 13px;
        color: #333;
    }
    .selected-addr-display.visible { display: flex; align-items: flex-start; gap: 10px; }
    .selected-addr-display i { color: #4caf50; margin-top: 2px; flex-shrink: 0; }
    .selected-addr-display .change-link {
        margin-left: auto; color: #d2691e; font-size: 12px;
        font-weight: 600; cursor: pointer; white-space: nowrap; flex-shrink: 0;
    }

    /* ── Store pickup info ── */
    #storeAddressGroup {
        display: none;
        padding: 15px;
        background: #fff5ee;
        border-radius: 12px;
        border: 2px solid #d2691e;
        margin-bottom: 16px;
    }

    /* ── Phone + Notes ── */
    .phone-notes-group { margin-top: 16px; display: flex; flex-direction: column; gap: 12px; }

    /* ── Pay Button ── */
    .pay-button {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #d2691e, #8b4513);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 17px;
        font-weight: 700;
        cursor: pointer;
        transition: all .2s;
        margin-top: 22px;
    }
    .pay-button:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(210,105,30,.3); }
    .pay-button:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

    /* spinner */
    .locate-spinner { display: none; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,.4); border-top-color: white; border-radius: 50%; animation: spin .7s linear infinite; flex-shrink: 0; }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>

<div class="payment-container">
    <div class="payment-card">
        {% csrf_token %}
        <div class="pay-title">&#x1F6D2; Complete Your Order</div>

        <!-- Order Summary -->
        <div class="order-summary">
            <h3>Order Summary</h3>
            <div id="orderItems"></div>
            <div class="order-item"><span>Subtotal:</span><span id="subtotal">&#8377;0.00</span></div>
            <div class="order-item"><span>Delivery Fee:</span><span id="deliveryFee">&#8377;50.00</span></div>
            <div class="order-total"><span>Total:</span><span id="totalAmount">&#8377;0.00</span></div>
        </div>

        <!-- Delivery Type Toggle -->
        <div class="delivery-toggle">
            <input type="radio" name="order_type" id="delivery" value="delivery" checked>
            <label for="delivery"><i class="fas fa-motorcycle"></i> Home Delivery</label>
            <input type="radio" name="order_type" id="takeaway" value="takeaway">
            <label for="takeaway"><i class="fas fa-store"></i> Pickup at Store</label>
        </div>

        <!-- DELIVERY SECTION -->
        <div id="deliverySectionWrapper">

            <!-- ① Saved Addresses -->
            {% if user.is_authenticated %}
            <div id="savedAddressesArea">
                <div class="section-label"><i class="fas fa-bookmark"></i> Saved Addresses</div>
                <div id="savedAddrGrid" class="saved-addr-grid"></div>
                <div id="noAddressMsg" style="display:none;font-size:13px;color:#aaa;margin-bottom:6px;">No saved addresses yet.</div>
                <div id="addrLimitMsg" class="addr-limit-msg" style="display:none;">
                    &#x26A0;&#xFE0F; You've saved 2 addresses (max). Delete one to add a new address.
                </div>
                <a class="add-new-btn" id="addNewAddrBtn" href="#">
                    <i class="fas fa-plus-circle"></i> Add a new address
                </a>
            </div>
            {% endif %}

            <!-- ② Selected address display (green bar) -->
            <div class="selected-addr-display" id="selectedAddrDisplay">
                <i class="fas fa-check-circle"></i>
                <span id="selectedAddrText"></span>
                <span class="change-link" id="changeAddrBtn">Change</span>
            </div>

            <!-- ③ Map + Form (shown when adding new or no saved) -->
            <div id="newAddressPanel">

                <!-- Map picker -->
                <div class="map-picker-section">
                    <div class="section-label"><i class="fas fa-map-marker-alt"></i> Locate on Map</div>
                    <div class="locate-btns">
                        <button type="button" class="locate-btn primary-btn" id="useCurrentLocBtn">
                            <span class="locate-spinner" id="locSpinner"></span>
                            <i class="fas fa-crosshairs" id="locIcon"></i>
                            <span id="locBtnText">Use Current Location</span>
                        </button>
                        <button type="button" class="locate-btn" id="toggleMapBtn">
                            <i class="fas fa-map"></i> Pin on Map
                        </button>
                    </div>
                    <div class="map-box" id="mapBox">
                        <div id="addrPickerMap"></div>
                        <div class="map-pin-overlay">&#x1F4CD;</div>
                    </div>
                    <div id="mapInstruction" style="font-size:12px;color:#888;margin-top:5px;display:none;">
                        <i class="fas fa-info-circle"></i> Drag/click the map to pin your exact location, then confirm below.
                    </div>
                </div>

                <!-- Address form -->
                <div id="addressFormSection">
                    <div class="section-label"><i class="fas fa-home"></i> Delivery Address Details</div>
                    <div class="addr-form-grid">
                        <div class="form-group span2">
                            <label>House/Flat/Floor/Building <span>*</span></label>
                            <input type="text" class="form-input" id="fldHouseFlat" placeholder="e.g. Flat 4B, Krishna Apartments" autocomplete="off">
                        </div>
                        <div class="form-group span2">
                            <label>Area / Street / Colony <span>*</span></label>
                            <input type="text" class="form-input" id="fldAreaStreet" placeholder="e.g. Chaitanyapuri, Dilsukhnagar">
                        </div>
                        <div class="form-group">
                            <label>Landmark (Optional)</label>
                            <input type="text" class="form-input" id="fldLandmark" placeholder="e.g. Near Max Store">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" class="form-input" id="fldCity" value="Hyderabad" placeholder="City">
                        </div>
                        <div class="form-group">
                            <label>Pincode</label>
                            <input type="text" class="form-input" id="fldPincode" placeholder="500060" maxlength="6">
                        </div>
                    </div>

                    {% if user.is_authenticated %}
                    <!-- Address type -->
                    <div style="margin-top:14px;">
                        <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#888;margin-bottom:8px;">Save As</div>
                        <div class="addr-type-row">
                            <div class="addr-type-btn selected" data-type="home">
                                <i class="fas fa-home"></i> Home
                            </div>
                            <div class="addr-type-btn" data-type="work">
                                <i class="fas fa-briefcase"></i> Work
                            </div>
                            <div class="addr-type-btn" data-type="other">
                                <i class="fas fa-map-pin"></i> Other
                            </div>
                        </div>
                    </div>

                    <!-- Save toggle -->
                    <div class="save-toggle-row">
                        <label for="saveAddrToggle">Save this address to my account</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="saveAddrToggle" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Confirm address button -->
                    <button type="button" class="pay-button" id="confirmAddrBtn" style="margin-top:14px;font-size:15px;padding:13px;">
                        <i class="fas fa-check"></i> Confirm This Address
                    </button>
                </div>

                <!-- hidden lat/lng -->
                <input type="hidden" id="addrLat">
                <input type="hidden" id="addrLng">
            </div>

            <!-- ④ Store pickup -->
            <div id="storeAddressGroup">
                <p style="color:#d2691e;font-weight:700;margin-bottom:4px;"><i class="fas fa-store"></i> Store Address</p>
                <p style="color:#8b4513;font-size:14px;">Hno:12-13-123/4, 3rd floor, Near Max Store, Chaitanyapuri, Hyderabad</p>
            </div>

            <!-- Phone + Notes -->
            <div class="phone-notes-group" id="phoneNotesGroup">
                <div class="form-group">
                    <label style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#888;">Phone Number <span style="color:#e53935">*</span></label>
                    <input type="tel" class="form-input" id="deliveryPhone" placeholder="10-digit mobile number" maxlength="10">
                </div>
                <div class="form-group">
                    <label style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#888;">Additional Notes (Optional)</label>
                    <textarea class="form-input" id="deliveryNotes" rows="2" placeholder="e.g. Ring the doorbell twice"></textarea>
                </div>
            </div>
        </div><!-- /deliverySectionWrapper -->

        <!-- Pay Button -->
        <button class="pay-button" id="payButton" type="button">
            Pay with Razorpay
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* ══════════════════════════════════════════════════════
   BAKERY PAYMENT PAGE - Address Picker + Saved Addresses
   ══════════════════════════════════════════════════════ */

const IS_LOGGED_IN = {{ user.is_authenticated|yesno:"true,false" }};
const SAVE_ADDR_URL = '/api/addresses/save/';
const GET_ADDR_URL  = '/api/addresses/';
const DEL_ADDR_URL  = '/api/addresses/{id}/delete/';
const BAKERY_LAT    = 17.3850;
const BAKERY_LNG    = 78.4867;
const CSRFTOKEN     = () => document.querySelector('[name=csrfmiddlewaretoken]').value;

/* ── State ── */
let map = null;
let mapVisible = false;
let pickedLat = null;
let pickedLng = null;
let geocoder = null;
let selectedAddrLabel = 'home';
let savedAddresses = [];
let selectedSavedAddrId = null;   // id of chosen saved addr, or null if typing new
let confirmedFullAddress = '';    // final address string to submit

/* ════════════════════════════════════
   ORDER SUMMARY
   ════════════════════════════════════ */
function loadOrderSummary() {
    const cart = JSON.parse(localStorage.getItem('bakeryCart')) || {};
    const container = document.getElementById('orderItems');
    let subtotal = 0;
    container.innerHTML = '';
    Object.entries(cart).forEach(([name, item]) => {
        const tot = item.price * item.quantity;
        subtotal += tot;
        container.insertAdjacentHTML('beforeend',
            `<div class="order-item"><span>${name} x${item.quantity}</span><span>&#8377;${tot.toFixed(2)}</span></div>`);
    });
    const isDelivery = document.querySelector('input[name="order_type"]:checked').value === 'delivery';
    const fee = isDelivery ? 50 : 0;
    document.getElementById('subtotal').textContent   = '&#8377;' + subtotal.toFixed(2);
    document.getElementById('deliveryFee').textContent = '&#8377;' + fee.toFixed(2);
    document.getElementById('totalAmount').textContent = '&#8377;' + (subtotal + fee).toFixed(2);
}

/* ════════════════════════════════════
   DELIVERY / TAKEAWAY TOGGLE
   ════════════════════════════════════ */
function initDeliveryToggle() {
    document.querySelectorAll('input[name="order_type"]').forEach(r => {
        r.addEventListener('change', () => {
            const isDelivery = r.value === 'delivery';
            document.getElementById('deliverySectionWrapper').style.display = isDelivery ? '' : '';
            document.getElementById('storeAddressGroup').style.display = isDelivery ? 'none' : 'block';
            document.getElementById('savedAddressesArea') && (document.getElementById('savedAddressesArea').style.display = isDelivery ? '' : 'none');
            document.getElementById('newAddressPanel').style.display = isDelivery ? '' : 'none';
            document.getElementById('phoneNotesGroup').style.display = '';
            loadOrderSummary();
        });
    });
}

/* ════════════════════════════════════
   SAVED ADDRESSES
   ════════════════════════════════════ */
async function loadSavedAddresses() {
    if (!IS_LOGGED_IN) return;
    try {
        const resp = await fetch(GET_ADDR_URL);
        const data = await resp.json();
        savedAddresses = data.addresses || [];
        renderSavedAddresses();
    } catch (e) { /* no-op */ }
}

const ADDR_ICONS = { home: 'fa-home', work: 'fa-briefcase', other: 'fa-map-pin' };

function renderSavedAddresses() {
    const grid     = document.getElementById('savedAddrGrid');
    const noMsg    = document.getElementById('noAddressMsg');
    const limitMsg = document.getElementById('addrLimitMsg');
    const addBtn   = document.getElementById('addNewAddrBtn');

    if (!grid) return;
    grid.innerHTML = '';

    if (savedAddresses.length === 0) {
        noMsg.style.display = 'block';
        limitMsg.style.display = 'none';
        addBtn.style.display = 'flex';
        showNewAddressPanel();
        return;
    }
    noMsg.style.display = 'none';
    savedAddresses.forEach(addr => {
        const icon  = ADDR_ICONS[addr.label] || 'fa-map-pin';
        const isSelected = addr.id === selectedSavedAddrId;
        const chip  = document.createElement('div');
        chip.className = 'saved-addr-chip' + (isSelected ? ' selected' : '');
        chip.dataset.id = addr.id;
        chip.innerHTML = `
            <span class="chip-delete" data-id="${addr.id}" title="Delete">&times;</span>
            <div class="chip-label"><i class="fas ${icon}"></i> ${addr.label.charAt(0).toUpperCase() + addr.label.slice(1)}</div>
            <div class="chip-address">${addr.full_address}</div>`;
        chip.addEventListener('click', (e) => {
            if (e.target.closest('.chip-delete')) return;
            selectSavedAddress(addr);
        });
        chip.querySelector('.chip-delete').addEventListener('click', (e) => {
            e.stopPropagation();
            deleteSavedAddress(addr.id, chip);
        });
        grid.appendChild(chip);
    });

    if (savedAddresses.length >= 2) {
        limitMsg.style.display = 'block';
        addBtn.style.display = 'none';
    } else {
        limitMsg.style.display = 'none';
        addBtn.style.display = 'flex';
    }

    // Auto-select default or first
    if (!selectedSavedAddrId) {
        const def = savedAddresses.find(a => a.is_default) || savedAddresses[0];
        if (def) selectSavedAddress(def);
    }
}

function selectSavedAddress(addr) {
    selectedSavedAddrId = addr.id;
    confirmedFullAddress = addr.full_address;
    pickedLat = addr.latitude;
    pickedLng = addr.longitude;

    // UI
    document.querySelectorAll('.saved-addr-chip').forEach(c => {
        c.classList.toggle('selected', parseInt(c.dataset.id) === addr.id);
    });

    // Show green bar
    document.getElementById('selectedAddrText').textContent = addr.full_address;
    document.getElementById('selectedAddrDisplay').classList.add('visible');

    // Hide new address panel
    document.getElementById('newAddressPanel').style.display = 'none';
}

function showNewAddressPanel() {
    selectedSavedAddrId = null;
    confirmedFullAddress = '';
    document.getElementById('newAddressPanel').style.display = '';
    document.getElementById('selectedAddrDisplay').classList.remove('visible');
    document.querySelectorAll('.saved-addr-chip').forEach(c => c.classList.remove('selected'));

    // Show form
    document.getElementById('addressFormSection').classList.add('visible');
}

async function deleteSavedAddress(id, chipEl) {
    if (!confirm('Delete this saved address?')) return;
    try {
        await fetch(DEL_ADDR_URL.replace('{id}', id), {
            method: 'DELETE',
            headers: { 'X-CSRFToken': CSRFTOKEN() }
        });
        savedAddresses = savedAddresses.filter(a => a.id !== id);
        if (selectedSavedAddrId === id) {
            selectedSavedAddrId = null;
            confirmedFullAddress = '';
            document.getElementById('selectedAddrDisplay').classList.remove('visible');
        }
        renderSavedAddresses();
    } catch (e) { alert('Could not delete address.'); }
}

/* ════════════════════════════════════
   GOOGLE MAPS PICKER
   ════════════════════════════════════ */
function initMap() {
    geocoder = new google.maps.Geocoder();
    // Map is lazy-loaded only when user clicks "Pin on Map"
}

function showMap(lat, lng) {
    const mapBox   = document.getElementById('mapBox');
    const mapInstr = document.getElementById('mapInstruction');
    mapBox.classList.add('visible');
    mapInstr.style.display = 'block';

    if (!map) {
        map = new google.maps.Map(document.getElementById('addrPickerMap'), {
            center: { lat: lat || BAKERY_LAT, lng: lng || BAKERY_LNG },
            zoom: 16,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
            zoomControl: true,
            styles: [{ featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }]
        });

        // Clicking or dragging map → reverse geocode at center
        map.addListener('idle', () => {
            const center = map.getCenter();
            geocodeLatLng(center.lat(), center.lng());
        });
    } else {
        if (lat && lng) map.setCenter({ lat, lng });
        map.setZoom(17);
    }
}

function geocodeLatLng(lat, lng) {
    if (!geocoder) return;
    pickedLat = lat;
    pickedLng = lng;
    geocoder.geocode({ location: { lat, lng } }, (results, status) => {
        if (status === 'OK' && results[0]) {
            fillAddressFromGeocodeResult(results[0]);
        }
    });
}

function fillAddressFromGeocodeResult(result) {
    const comps = result.address_components;
    let houseNum = '', route = '', sublocality = '', locality = '', city = '', pincode = '';

    comps.forEach(c => {
        if (c.types.includes('street_number'))              houseNum   = c.long_name;
        if (c.types.includes('route'))                      route      = c.long_name;
        if (c.types.includes('sublocality_level_1') || c.types.includes('sublocality'))
                                                            sublocality = c.long_name;
        if (c.types.includes('locality'))                   locality   = c.long_name;
        if (c.types.includes('postal_code'))                pincode    = c.long_name;
        if (c.types.includes('administrative_area_level_1')) {}
    });

    // Area + street
    const streetFull = [houseNum, route].filter(Boolean).join(' ');
    const areaFull   = [sublocality, streetFull].filter(Boolean).join(', ') || result.formatted_address.split(',').slice(0,2).join(',');

    // Only auto-fill area/street, not house (user must fill that)
    if (document.getElementById('fldAreaStreet').value === '') {
        document.getElementById('fldAreaStreet').value = areaFull;
    }
    if (locality) document.getElementById('fldCity').value = locality;
    if (pincode) document.getElementById('fldPincode').value = pincode;

    // Show form
    document.getElementById('addressFormSection').classList.add('visible');
}

/* ── Use Current Location ── */
function useCurrentLocation() {
    if (!navigator.geolocation) {
        alert('Geolocation not supported by your browser.');
        return;
    }
    const btn    = document.getElementById('useCurrentLocBtn');
    const spinner= document.getElementById('locSpinner');
    const icon   = document.getElementById('locIcon');
    const text   = document.getElementById('locBtnText');

    btn.disabled = true;
    spinner.style.display = 'inline-block';
    icon.style.display    = 'none';
    text.textContent      = 'Locating...';

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            pickedLat = lat; pickedLng = lng;

            showMap(lat, lng);
            geocodeLatLng(lat, lng);

            btn.disabled = false;
            spinner.style.display = 'none';
            icon.style.display    = 'inline';
            text.textContent      = 'Location found ✓';
            setTimeout(() => { text.textContent = 'Use Current Location'; }, 3000);
        },
        (err) => {
            btn.disabled = false;
            spinner.style.display = 'none';
            icon.style.display    = 'inline';
            text.textContent      = 'Use Current Location';
            if (err.code === 1) {
                alert('Location permission denied. Please allow location access in your browser.');
            } else {
                alert('Could not detect location. Please pin on map manually.');
                toggleMap();
            }
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

function toggleMap() {
    mapVisible = !mapVisible;
    const mapBox  = document.getElementById('mapBox');
    const mapInstr = document.getElementById('mapInstruction');
    const btn     = document.getElementById('toggleMapBtn');
    if (mapVisible) {
        showMap(pickedLat || BAKERY_LAT, pickedLng || BAKERY_LNG);
        btn.innerHTML = '<i class="fas fa-times"></i> Close Map';
        document.getElementById('addressFormSection').classList.add('visible');
    } else {
        mapBox.classList.remove('visible');
        mapInstr.style.display = 'none';
        btn.innerHTML = '<i class="fas fa-map"></i> Pin on Map';
    }
}

/* ── Address type buttons ── */
function initAddressTypeButtons() {
    document.querySelectorAll('.addr-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.addr-type-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedAddrLabel = btn.dataset.type;
        });
    });
}

/* ════════════════════════════════════
   CONFIRM ADDRESS
   ════════════════════════════════════ */
async function confirmAddress() {
    const houseFlatEl  = document.getElementById('fldHouseFlat');
    const areaStreetEl = document.getElementById('fldAreaStreet');
    const landmarkEl   = document.getElementById('fldLandmark');
    const cityEl       = document.getElementById('fldCity');
    const pincodeEl    = document.getElementById('fldPincode');

    const houseFlat  = houseFlatEl.value.trim();
    const areaStreet = areaStreetEl.value.trim();
    const landmark   = landmarkEl.value.trim();
    const city       = cityEl.value.trim() || 'Hyderabad';
    const pincode    = pincodeEl.value.trim();

    // Validate
    let err = false;
    [houseFlatEl, areaStreetEl].forEach(el => el.classList.remove('error'));
    if (!houseFlat) { houseFlatEl.classList.add('error'); houseFlatEl.focus(); err = true; }
    if (!areaStreet) { areaStreetEl.classList.add('error'); if (!err) { areaStreetEl.focus(); } err = true; }
    if (err) return;

    // Build full address
    const parts = [houseFlat, areaStreet];
    if (landmark) parts.push(landmark);
    parts.push(city);
    if (pincode) parts.push(pincode);
    confirmedFullAddress = parts.join(', ');

    // Save to account?
    const shouldSave = IS_LOGGED_IN && document.getElementById('saveAddrToggle')?.checked;
    if (shouldSave) {
        try {
            const resp = await fetch(SAVE_ADDR_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFTOKEN() },
                body: JSON.stringify({
                    house_flat: houseFlat,
                    area_street: areaStreet,
                    landmark, city, pincode,
                    label: selectedAddrLabel,
                    latitude: pickedLat,
                    longitude: pickedLng,
                })
            });
            const result = await resp.json();
            if (!result.success && result.limit_reached) {
                // warn but proceed
                alert('Address limit reached (2 max) — proceeding without saving.');
            } else if (result.success) {
                await loadSavedAddresses();
            }
        } catch (e) { /* proceed even if save fails */ }
    }

    // Show green confirmation bar
    document.getElementById('selectedAddrText').textContent = confirmedFullAddress;
    document.getElementById('selectedAddrDisplay').classList.add('visible');
    document.getElementById('newAddressPanel').style.display = 'none';
}

/* ════════════════════════════════════
   PROCESS PAYMENT (submit form)
   ════════════════════════════════════ */
function processPayment() {
    const orderType  = document.querySelector('input[name="order_type"]:checked').value;
    const phone      = document.getElementById('deliveryPhone').value.trim();
    const notes      = document.getElementById('deliveryNotes').value.trim();

    // Validate phone
    if (!phone || !/^\d{10}$/.test(phone)) {
        document.getElementById('deliveryPhone').classList.add('error');
        document.getElementById('deliveryPhone').focus();
        alert('Please enter a valid 10-digit phone number');
        return;
    }

    // Validate delivery address
    if (orderType === 'delivery' && !confirmedFullAddress) {
        alert('Please confirm your delivery address first.');
        return;
    }

    const cart = JSON.parse(localStorage.getItem('bakeryCart')) || {};
    if (!Object.keys(cart).length) {
        alert('Your cart is empty!');
        window.location.href = "{% url 'menu' %}";
        return;
    }

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = "{% url 'payment' %}";

    const appendInput = (name, value) => {
        const inp = document.createElement('input');
        inp.type = 'hidden'; inp.name = name; inp.value = value;
        form.appendChild(inp);
    };

    appendInput('csrfmiddlewaretoken', CSRFTOKEN());
    appendInput('order_type', orderType);
    appendInput('cart_data', JSON.stringify(cart));
    appendInput('delivery_address', orderType === 'delivery' ? confirmedFullAddress : 'Store Pickup');
    appendInput('delivery_phone', phone);
    appendInput('delivery_notes', notes);
    if (pickedLat) appendInput('delivery_lat', pickedLat);
    if (pickedLng) appendInput('delivery_lng', pickedLng);

    document.body.appendChild(form);
    form.submit();
}

/* ════════════════════════════════════
   CART NAV UPDATE
   ════════════════════════════════════ */
function updateCartDisplay() {
    const cart = JSON.parse(localStorage.getItem('bakeryCart')) || {};
    const qty  = Object.values(cart).reduce((s, i) => s + i.quantity, 0);
    const price= Object.values(cart).reduce((s, i) => s + i.price * i.quantity, 0);
    const qEl  = document.querySelector('#quantity');
    const pEl  = document.querySelector('#cart_price');
    if (qEl) qEl.textContent = qty;
    if (pEl) pEl.textContent = '&#8377;' + price.toFixed(2);
}

/* ════════════════════════════════════
   INIT
   ════════════════════════════════════ */
document.addEventListener('DOMContentLoaded', () => {
    loadOrderSummary();
    initDeliveryToggle();
    updateCartDisplay();
    initAddressTypeButtons();

    document.getElementById('useCurrentLocBtn')?.addEventListener('click', useCurrentLocation);
    document.getElementById('toggleMapBtn')?.addEventListener('click', toggleMap);
    document.getElementById('confirmAddrBtn')?.addEventListener('click', confirmAddress);
    document.getElementById('payButton')?.addEventListener('click', processPayment);
    document.getElementById('addNewAddrBtn')?.addEventListener('click', (e) => { e.preventDefault(); showNewAddressPanel(); });
    document.getElementById('changeAddrBtn')?.addEventListener('click', showNewAddressPanel);

    // Load saved addresses from server
    loadSavedAddresses();

    // If not logged in, show address form immediately
    if (!IS_LOGGED_IN) {
        document.getElementById('addressFormSection').classList.add('visible');
    }

    // Phone validation on input
    document.getElementById('deliveryPhone')?.addEventListener('input', function() {
        this.classList.remove('error');
    });
});
</script>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY|default:'AIzaSyCJvjpt_gZpTbMXxHYK5qIXeQE-VfumNY8' }}&libraries=places&callback=initMap">
</script>
{% endblock %}

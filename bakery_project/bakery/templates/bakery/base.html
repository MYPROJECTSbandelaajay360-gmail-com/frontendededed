<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}TheBakeStory{% endblock %}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.css"
        integrity="sha512-kJlvECunwXftkPwyvHbclArO8wszgBGisiLeuDFwNM8ws+wKIw0sv1os3ClWZOcrEB2eRXULYUsm8OVRGJKwGA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
        integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Profile Dropdown Styles */
        .profile-dropdown-container {
            position: relative;
            display: inline-block;
        }

        .profile-trigger {
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #fff;
            border: 1px solid #f1f2f6;
        }

        .profile-trigger:hover {
            background: #fffaf5;
            border-color: #d2691e;
        }

        .trigger-avatar {
            width: 41px;
            height: 41px;
            border-radius: 11px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid #f1f2f6;
            transition: all 0.3s ease;
        }

        .login-icon i {
            font-size: 38px;
            color: #d2691e;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-icon:hover i {
            transform: scale(1.1);
            color: #a0522d;
        }

        .trigger-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .trigger-info {
            text-align: left;
            display: none;
            /* Hide on small screens */
        }

        @media (min-width: 768px) {
            .trigger-info {
                display: block;
            }
        }

        .trigger-info h4 {
            font-size: 14px;
            color: #2d3436;
            margin: 0;
            font-weight: 700;
            line-height: 1.2;
            text-transform: uppercase;
        }

        .trigger-info span {
            font-size: 11px;
            color: #636e72;
            font-weight: 600;
        }

        .profile-trigger i.chevron {
            font-size: 14px;
            color: #b2bec3;
            margin-left: 5px;
        }

        .profile-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            width: 252px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            margin-top: 15px;
            display: none;
            z-index: 1000;
            overflow: hidden;
            animation: fadeInDown 0.3s ease;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-dropdown-menu.active {
            display: block;
        }

        .profile-header {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: #fffaf5;
        }

        .profile-avatar {
            width: 52px;
            height: 52px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #d2691e;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info h3 {
            font-size: 16px;
            color: #2d3436;
            margin-bottom: 4px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .profile-info p {
            font-size: 13px;
            color: #636e72;
            word-break: break-all;
        }

        .admin-badge {
            display: inline-block;
            background: #ffebd8;
            color: #d2691e;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin-top: 5px;
        }

        .profile-dropdown-menu hr {
            border: none;
            border-top: 1px solid #f1f2f6;
            margin: 0;
        }

        .profile-links {
            padding: 10px 0;
        }

        .profile-links a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            color: #2d3436;
            text-decoration: none;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .profile-links i {
            width: 20px;
            color: #b2bec3;
            font-size: 16px;
        }

        .profile-links a:hover {
            background: #fffaf5;
            color: #d2691e;
        }

        .profile-links a:hover i {
            color: #d2691e;
        }

        .profile-footer {
            padding: 8px 0;
        }

        .sign-out-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            color: #e74c3c !important;
            text-decoration: none;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .sign-out-btn:hover {
            background: #fff5f5;
        }

        .sign-out-btn i {
            font-size: 16px;
        }

        /* hello cssschatbot cssss */
        /* Chatbot CSS - Paste your CSS code here */
        /* ========================================
   FLOATING CHATBOT WIDGET STYLES
   Hospital-inspired AI Chatbot Interface
   ======================================== */

        /* Chatbot Toggle Button */
        .chatbot-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d2691e 0%, #cd853f 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(210, 105, 30, 0.4);
            border: 3px solid #fff;
            transition: all 0.3s ease;
            z-index: 10000;
            animation: pulse 2s infinite;
        }

        .chatbot-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(210, 105, 30, 0.6);
        }

        .chatbot-toggle i {
            font-size: 35px;
            color: white;
        }

        .chatbot-toggle .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff3838;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid white;
            animation: bounce 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 8px 25px rgba(210, 105, 30, 0.4);
            }

            50% {
                box-shadow: 0 8px 35px rgba(210, 105, 30, 0.7),
                    0 0 0 10px rgba(210, 105, 30, 0.1);
            }
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        /* Chatbot Container */
        .chatbot-container {
            position: fixed;
            bottom: 120px;
            right: 30px;
            width: 350px;
            height: 450px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 9999;
            animation: slideUp 0.4s ease;
        }

        .chatbot-container.active {
            display: flex;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Chatbot Header */
        .chatbot-header {
            background: linear-gradient(135deg, #d2691e 0%, #cd853f 100%);
            padding: 12px 20px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chatbot-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bot-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .bot-info h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .bot-info p {
            margin: 3px 0 0;
            font-size: 12px;
            opacity: 0.9;
        }

        .bot-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4caf50;
            border-radius: 50%;
            margin-right: 5px;
            animation: blink 2s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .chatbot-actions {
            display: flex;
            gap: 10px;
        }

        .chatbot-actions button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-actions button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Quick Actions Panel */
        .quick-actions {
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
            overflow-x: auto;
        }

        .quick-action-btn {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            color: #333;
        }

        .quick-action-btn:hover {
            background: #d2691e;
            color: white;
            border-color: #d2691e;
            transform: translateY(-2px);
        }

        .quick-action-btn i {
            margin-right: 5px;
        }

        /* Chat Messages Area */
        .chatbot-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
            scroll-behavior: smooth;
        }

        .chatbot-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chatbot-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chatbot-messages::-webkit-scrollbar-thumb {
            background: #d2691e;
            border-radius: 3px;
        }

        .message {
            display: flex;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, #d2691e 0%, #cd853f 100%);
            color: white;
            margin-right: 10px;
        }

        .message.user .message-avatar {
            background: #fff3e0;
            color: #d2691e;
            margin-left: 10px;
        }

        .message-content {
            max-width: 70%;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 14px;
        }

        .message.bot .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #d2691e 0%, #cd853f 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
            padding: 0 5px;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-indicator .message-avatar {
            background: linear-gradient(135deg, #d2691e 0%, #cd853f 100%);
            color: white;
        }

        .typing-dots {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 12px 16px;
            border-radius: 18px;
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #d2691e;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: 0.7;
            }

            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Suggested Actions */
        .suggested-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .suggested-action {
            background: white;
            border: 1px solid #d2691e;
            color: #d2691e;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suggested-action:hover {
            background: #d2691e;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(210, 105, 30, 0.3);
        }

        /* Product Card in Chat */
        .product-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            overflow: hidden;
        }

        .product-card img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .product-info {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .product-info h4 {
            margin: 0 0 8px;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .product-info p {
            margin: 0 0 8px;
            font-size: 13px;
            color: #666;
        }

        .product-price {
            font-size: 18px;
            font-weight: bold;
            color: #d2691e;
            margin: 8px 0 12px;
        }

        .product-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            width: 100%;
        }

        .product-actions button {
            width: 100%;
            max-width: 250px;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-order {
            background: #d2691e;
            color: white;
        }

        .btn-order:hover {
            background: #cd853f;
            transform: scale(1.05);
        }

        .btn-view {
            background: white;
            color: #d2691e;
            border: 1px solid #d2691e;
        }

        .btn-view:hover {
            background: #fff5f5;
        }

        /* Chat Input Area */
        .chatbot-input {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .chatbot-input input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .chatbot-input input:focus {
            border-color: #d2691e;
            box-shadow: 0 0 0 3px rgba(210, 105, 30, 0.1);
        }

        .chatbot-input input::placeholder {
            color: #999;
        }

        .attach-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .attach-btn:hover {
            color: #d2691e;
        }

        .send-btn {
            background: linear-gradient(135deg, #d2691e 0%, #cd853f 100%);
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(210, 105, 30, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Welcome Screen */
        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .welcome-screen i {
            font-size: 60px;
            color: #d2691e;
            margin-bottom: 20px;
        }

        .welcome-screen h3 {
            color: #333;
            margin: 0 0 10px;
        }

        .welcome-screen p {
            margin: 0 0 20px;
            font-size: 14px;
        }

        .welcome-features {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
            text-align: left;
        }

        .feature-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }

        .feature-item i {
            font-size: 24px;
            color: #d2691e;
            margin-bottom: 10px;
        }

        .feature-item h4 {
            margin: 0 0 5px;
            font-size: 14px;
            color: #333;
        }

        .feature-item p {
            margin: 0;
            font-size: 12px;
            color: #666;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .chatbot-container {
                width: 100%;
                height: 100%;
                bottom: 0;
                right: 0;
                border-radius: 0;
            }

            .chatbot-toggle {
                bottom: 20px;
                right: 20px;
                width: 60px;
                height: 60px;
            }

            .chatbot-toggle i {
                font-size: 28px;
            }

            .welcome-features {
                grid-template-columns: 1fr;
            }
        }

        /* Error Message */
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            margin: 10px 0;
            border-left: 3px solid #c62828;
        }

        /* Success Message */
        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            margin: 10px 0;
            border-left: 3px solid #2e7d32;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            pointer-events: none;
        }

        .toast-notification {
            background: white;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
            pointer-events: auto;
            animation: toastIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-left: 4px solid #d2691e;
            min-width: 200px;
        }

        .toast-notification.success {
            border-left-color: #2e7d32;
        }

        .toast-notification.error {
            border-left-color: #e74c3c;
        }

        .toast-notification.info {
            border-left-color: #3498db;
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .toast-notification.fade-out {
            animation: toastOut 0.3s ease forwards;
        }

        @keyframes toastOut {
            to {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>

<body>
    <main>
        <nav>
            <aside id="nav1"><a href="{% url 'index' %}">
                    <h1>The Bake Story</h1>
                </a></aside>
            <aside id="nav2">
                {% if user_role == 'admin' %}
                <a href="{% url 'admin_dashboard' %}" style="color:#170f0ae2;font-weight:600;">Dashboard</a>
                <a href="{% url 'kitchen_portal' %}" style="color:#170f0ae2;font-weight:600;">Kitchen Portal</a>
                <a href="{% url 'menu_management' %}" style="color:#170f0ae2;font-weight:600;">Menu Management</a>
                <!-- <a href="{% url 'payment_management' %}" style="color:#d2691e;font-weight:600;">Payments</a> -->
                {% else %}
                <a href="{% url 'index' %}">Home</a>
                <a href="{% url 'menu' %}">Menu</a>
                <a href="{% url 'about' %}">About</a>
                <a href="{% url 'contact' %}">Contact</a>
                {% if user.is_authenticated %}
                <a href="{% url 'orders' %}">Orders</a>
                {% endif %}
                {% if user_role == 'driver' %}
                <a href="{% url 'driver_dashboard' %}" style="color:#1565c0;font-weight:600;">Deliveries</a>
                {% endif %}
                {% endif %}
            </aside>
            <aside id="nav3">

                {% if user_role != 'admin' %}
                <a href="{% url 'cart' %}">
                    <i class="ri-shopping-cart-2-line"></i>
                    <div id="quantity" class="quantity">0</div>
                    <p id="cart_price">‚Çπ0.00</p>
                </a>
                {% endif %}
                {% comment %} {% if user.is_authenticated %}
                {% endif %} {% endcomment %}
            </aside>
            <aside id="nav4">
                <div class="profile-dropdown-container">
                    {% if user.is_authenticated %}
                    <div class="profile-trigger" id="profileTrigger">
                        <div class="trigger-avatar">
                            <img src="https://ui-avatars.com/api/?name={{ user.first_name|default:user.username }}+{{ user.last_name|default:'' }}&background=d2691e&color=fff&bold=true"
                                alt="Avatar">
                        </div>
                        <div class="trigger-info">
                            <h4>{{ user.first_name|default:user.username }}</h4>
                            <span>{% if user_role == 'admin' %}Admin{% elif user_role == 'driver' %}Driver{% else %}Customer{% endif %}</span>
                        </div>
                        <i class="fas fa-chevron-down chevron"></i>
                    </div>
                    <!-- Profile Dropdown Card -->
                    <div class="profile-dropdown-menu" id="profileDropdown">
                        <div class="profile-header">
                            <div class="profile-avatar">
                                <img src="https://ui-avatars.com/api/?name={{ user.first_name|default:user.username }}+{{ user.last_name|default:'' }}&background=d2691e&color=fff&bold=true"
                                    alt="Avatar">
                            </div>
                            <div class="profile-info">
                                <h3>{{ user.first_name|default:user.username }} {{ user.last_name|default:'' }}</h3>
                                <p>{{ user.email }}</p>
                                {% if user_role == 'admin' %}
                                <span class="admin-badge">Admin</span>
                                {% elif user_role == 'driver' %}
                                <span class="admin-badge"
                                    style="background:linear-gradient(135deg,#1565c0,#1976d2);color:white;">Driver</span>
                                {% endif %}
                            </div>
                        </div>
                        <hr>
                        <div class="profile-links">
                            {% if user_role != 'admin' %}
                            <a href="{% url 'orders' %}"><i class="fas fa-shopping-bag"></i> My Orders</a>
                            <a href="{% url 'contact' %}"><i class="fas fa-phone-alt"></i> Contact Us</a>
                            <a href="{% url 'about' %}"><i class="fas fa-info-circle"></i> About Us</a>
                            {% endif %}
                        </div>
                        {% if user_role == 'admin' %}
                        <hr>
                        <div class="profile-links">
                            <a href="{% url 'admin_dashboard' %}" style="color:#d2691e;"><i
                                    class="fas fa-tachometer-alt"></i> Admin Dashboard</a>
                            <a href="{% url 'kitchen_portal' %}" style="color:#d2691e;"><i class="fas fa-utensils"></i>
                                Kitchen Portal</a>
                            <a href="{% url 'menu_management' %}" style="color:#d2691e;"><i
                                    class="fas fa-book-open"></i> Menu Management</a>
                            <a href="{% url 'payment_management' %}" style="color:#d2691e;"><i
                                    class="fas fa-credit-card"></i> Payments</a>
                            <a href="{% url 'user_management' %}" style="color:#d2691e;"><i class="fas fa-users"></i>
                                User Management</a>
                            <a href="{% url 'role_management' %}" style="color:#d2691e;"><i
                                    class="fas fa-user-shield"></i> Role Management</a>
                        </div>
                        {% endif %}
                        {% if user_role == 'driver' %}
                        <hr>
                        <div class="profile-links">
                            <a href="{% url 'driver_dashboard' %}" style="color:#1565c0;"><i class="fas fa-truck"></i>
                                My Deliveries</a>
                        </div>
                        {% endif %}
                        <hr>
                        <div class="profile-footer">
                            <a href="{% url 'logout' %}" class="sign-out-btn">
                                <i class="fas fa-sign-out-alt"></i> Sign Out
                            </a>
                        </div>
                    </div>
                    {% else %}
                    <div class="profile-trigger" id="guestTrigger">
                        <div class="login-icon"><i class="fa-solid fa-circle-user"></i></div>
                        <i class="fas fa-chevron-down chevron"></i>
                    </div>
                    <!-- Guest Dropdown Card -->
                    <div class="profile-dropdown-menu" id="guestDropdown">
                        <div class="profile-links">
                            <a href="{% url 'login' %}"><i class="fas fa-sign-in-alt"></i> Login</a>
                            <a href="{% url 'signup' %}"><i class="fas fa-user-plus"></i> Sign Up</a>
                            <a href="{% url 'about' %}"><i class="fas fa-info-circle"></i> About Us</a>
                            <a href="{% url 'contact' %}"><i class="fas fa-phone-alt"></i> Contact Us</a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </aside>
        </nav>
    </main>

    <!-- Floating Chatbot Widget -->
    <div class="chatbot-toggle" id="chatbotToggle">
        <div style="font-size: 35px;">üçΩÔ∏è</div>
        <div class="notification-badge" id="chatNotification" style="display: none;">1</div>
    </div>

    <!-- Chatbot Container -->
    <div class="chatbot-container" id="chatbotContainer">
        <!-- Header -->
        <div class="chatbot-header">
            <div class="chatbot-header-left">
                <div class="bot-avatar">üç∞</div>
                <div class="bot-info">
                    <h3>Bake Story Assistant</h3>
                    <p><span class="bot-status"></span>Online - Ready to help!</p>
                </div>
            </div>
            <div class="chatbot-actions">
                <button onclick="refreshChat()" title="Refresh"><i class="fas fa-sync-alt"></i></button>
                <button onclick="minimizeChat()" title="Minimize"><i class="fas fa-minus"></i></button>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="quick-action-btn" onclick="sendQuickMessage('Show me today\'s specials')">
                <i class="fas fa-star"></i> Specials
            </button>
            <button class="quick-action-btn" onclick="sendQuickMessage('What cakes do you have?')">
                <i class="fas fa-birthday-cake"></i> Cakes
            </button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Show my orders')">
                <i class="fas fa-shopping-bag"></i> Orders
            </button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Contact information')">
                <i class="fas fa-phone"></i> Contact
            </button>
        </div>

        <!-- Messages Area -->
        <div class="chatbot-messages" id="chatMessages">
            <div class="welcome-screen" id="welcomeScreen">
                <i class="fas fa-robot"></i>
                <h3>Welcome to The Bake Story!</h3>
                <p>I'm your AI assistant. How can I help you today?</p>

                <div class="welcome-features">
                    <div class="feature-item">
                        <i class="fas fa-search"></i>
                        <h4>Browse Menu</h4>
                        <p>Explore our delicious items</p>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-shopping-cart"></i>
                        <h4>Place Orders</h4>
                        <p>Order your favorites easily</p>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-clock"></i>
                        <h4>Track Orders</h4>
                        <p>Check your order status</p>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-headset"></i>
                        <h4>Get Support</h4>
                        <p>24/7 assistance available</p>
                    </div>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <div class="message-avatar">üç∞</div>
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="chatbot-input">
            <div class="input-wrapper">
                <input type="text" id="chatInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                <button class="attach-btn" title="Attach file">
                    <i class="fas fa-paperclip"></i>
                </button>
            </div>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    {% comment %}

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endcomment %}

    {% block content %}
    {% endblock %}

    <script>
        const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
        const csrftoken = '{{ csrf_token }}';

        function showToast(message, type = 'info') {
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.innerHTML = `
            <div class="toast-icon">
                ${type === 'success' ? '<i class="fas fa-check-circle"></i>' :
                    type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' :
                        '<i class="fas fa-info-circle"></i>'}
            </div>
            <div class="toast-message">${message}</div>
        `;
            container.appendChild(toast);


            // Remove after 2 seconds
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // Process Django Messages
        document.addEventListener('DOMContentLoaded', function () {
            {% if messages %}
            {% for message in messages %}
            let type = 'info';
            {% if message.tags == 'success' %} type = 'success';
            {% elif message.tags == 'error' or message.tags == 'danger' %} type = 'error';
            {% endif %}
            showToast('{{ message|escapejs }}', type);
            {% endfor %}
            {% endif %}
        });

        function updateCartDisplay() {
            console.log('=== BASE updateCartDisplay called ===');

            // Get cart from localStorage
            let cart;
            try {
                cart = JSON.parse(localStorage.getItem('bakeryCart')) || {};
            } catch (e) {
                console.error('BASE - Error parsing cart from localStorage:', e);
                cart = {};
            }

            console.log('BASE - Current cart from localStorage:', cart);

            let totalQuantity = 0;
            let totalPrice = 0;

            // Calculate totals from cart with error checking
            Object.keys(cart).forEach(itemId => {
                const item = cart[itemId];
                if (item && typeof item === 'object') {
                    const qty = parseInt(item.quantity) || 0;
                    const price = parseFloat(item.price) || 0;
                    totalQuantity += qty;
                    totalPrice += price * qty;
                    console.log(`BASE - Item ${itemId}: qty=${qty}, price=${price}, subtotal=${price * qty}`);
                }
            });

            console.log('BASE - Total quantity:', totalQuantity);
            console.log('BASE - Total price:', totalPrice);

            // Update navbar display
            const navQuantity = document.querySelector('#quantity') ||
                document.querySelector('.quantity') ||
                document.querySelector('#nav3 .quantity');
            const cartPrice = document.querySelector('#cart_price') ||
                document.querySelector('#nav3 p');

            console.log('BASE - Found navQuantity element:', navQuantity);
            console.log('BASE - Found cartPrice element:', cartPrice);

            if (navQuantity) {
                navQuantity.textContent = totalQuantity.toString();
                console.log('BASE - Updated quantity display to:', totalQuantity);
            } else {
                console.error('BASE - Could not find quantity element in navbar');
            }

            if (cartPrice) {
                cartPrice.textContent = `‚Çπ${totalPrice.toFixed(2)}`;
                console.log('BASE - Updated price display to:', `‚Çπ${totalPrice.toFixed(2)}`);
            } else {
                console.error('BASE - Could not find price element in navbar');
            }

            console.log('=== BASE updateCartDisplay completed ===');
        }

        // Update cart display on page load
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Base.html: DOM loaded, updating cart display');
            updateCartDisplay();
        });

        // Listen for storage changes (when cart is updated in another tab or by other scripts)
        window.addEventListener('storage', function (e) {
            if (e.key === 'bakeryCart') {
                console.log('Cart updated in storage, refreshing display');
                updateCartDisplay();
            }
        });

        // Custom event for same-page cart updates
        window.addEventListener('cartUpdated', function () {
            console.log('Cart updated event received, refreshing display');
            updateCartDisplay();
        });

        // Profile Dropdown Toggle Logic
        document.addEventListener('DOMContentLoaded', function () {
            // Function to handle dropdown toggles
            function setupDropdown(triggerId, dropdownId) {
                const trigger = document.getElementById(triggerId);
                const dropdown = document.getElementById(dropdownId);

                if (trigger && dropdown) {
                    trigger.addEventListener('click', function (e) {
                        e.stopPropagation();
                        // Close other dropdowns first
                        const allDropdowns = document.querySelectorAll('.profile-dropdown-menu');
                        allDropdowns.forEach(d => {
                            if (d !== dropdown) d.classList.remove('active');
                        });
                        dropdown.classList.toggle('active');
                    });

                    // Close dropdown when clicking anywhere else
                    document.addEventListener('click', function (e) {
                        if (!dropdown.contains(e.target) && !trigger.contains(e.target)) {
                            dropdown.classList.remove('active');
                        }
                    });
                }
            }

            // Setup both authenticated and guest dropdowns
            setupDropdown('profileTrigger', 'profileDropdown');
            setupDropdown('guestTrigger', 'guestDropdown');
        });

        // ========================================
        // CHATBOT FUNCTIONALITY
        // ========================================

        const chatbotToggle = document.getElementById('chatbotToggle');
        const chatbotContainer = document.getElementById('chatbotContainer');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const chatNotification = document.getElementById('chatNotification');

        const API_URL = '/api/chatbot/query/';
        let messageHistory = [];
        let currentOrderSession = null;
        let orderStep = null; // 'search', 'select_item', 'address', 'payment'
        let pendingOrderConfirmation = null; // Store pending order details for confirmation
        let chatbotCart = []; // Shopping cart for multiple items

        // Clear all order state
        function clearOrderState() {
            console.log('üßπ Clearing order state');
            currentOrderSession = null;
            orderStep = null;
            pendingOrderConfirmation = null;
            chatbotCart = [];
        }

        // Toggle chatbot
        chatbotToggle.addEventListener('click', function () {
            chatbotContainer.classList.toggle('active');
            if (chatbotContainer.classList.contains('active')) {
                chatInput.focus();
                chatNotification.style.display = 'none';
            }
        });

        // Minimize chat
        function minimizeChat() {
            chatbotContainer.classList.remove('active');
        }

        // Refresh chat
        function refreshChat() {
            clearOrderState();
            messageHistory = [];
            chatMessages.innerHTML = '';
            welcomeScreen.style.display = 'block';
            addMessage('bot', 'Chat refreshed! How can I help you?');
        }

        // Handle Enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Send quick message
        function sendQuickMessage(message) {
            chatInput.value = message;
            sendMessage();
        }

        // Send message
        async function sendMessage() {
            const message = chatInput.value.trim();

            if (!message) return;

            console.log('üì® sendMessage called with:', message);
            console.log('üìã Current pendingOrderConfirmation:', pendingOrderConfirmation);

            // Hide welcome screen
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }

            // Add user message
            addMessage('user', message);
            chatInput.value = '';

            // Check if waiting for order confirmation
            if (pendingOrderConfirmation) {
                console.log('‚è≥ Pending confirmation detected, calling handleOrderSearch');
                await handleOrderSearch(message);
                return;
            }

            // Check if this is part of order flow
            if (orderStep === 'address') {
                await handleAddressInput(message);
                return;
            }

            // Handle special commands from quick action buttons
            const lowerMsg = message.toLowerCase().trim();

            // "Show my orders" command
            if (lowerMsg.includes('show my orders') || lowerMsg.includes('my orders') || lowerMsg === 'orders') {
                if (!isAuthenticated) {
                    addMessage('bot', 'üîí Please login to view your orders.');
                    const loginCard = document.createElement('div');
                    loginCard.className = 'message bot';
                    loginCard.innerHTML = `
    <div class="message-avatar">üç∞</div>
    <div class="message-content">
        <div class="suggested-actions">
            <button class="suggested-action" onclick="window.location.href='/login/'">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
        </div>
    </div>
    `;
                    chatMessages.appendChild(loginCard);
                } else {
                    window.location.href = '/orders/';
                }
                scrollToBottom();
                sendBtn.disabled = false;
                return;
            }

            // "What cakes do you have" / "Show me cakes" command
            if (lowerMsg.includes('what cakes') || lowerMsg.includes('show me cakes') || lowerMsg.includes('show cakes') ||
                lowerMsg === 'cakes' || lowerMsg === 'menu' || lowerMsg === 'full menu') {
                typingIndicator.classList.add('active');
                sendBtn.disabled = true;

                try {
                    const response = await fetch('/api/chatbot/order/search/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({ query: 'cake' })
                    });

                    const data = await response.json();
                    typingIndicator.classList.remove('active');

                    if (data.found && data.items.length > 0) {
                        addMessage('bot', `üç∞ Here are our delicious cakes:`);
                        displayMenuItems(data.items, 1);
                    } else {
                        addMessage('bot', 'üòî Sorry, no cakes available right now.');
                    }
                } catch (error) {
                    typingIndicator.classList.remove('active');
                    addMessage('bot', 'Error fetching menu. Please try again.');
                }

                sendBtn.disabled = false;
                scrollToBottom();
                return;
            }

            // "Show specials" command
            if (lowerMsg.includes('specials') || lowerMsg.includes('special')) {
                typingIndicator.classList.add('active');
                sendBtn.disabled = true;

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({ query: "What are today's specials?" })
                    });

                    const data = await response.json();
                    typingIndicator.classList.remove('active');

                    if (data.status === 'success') {
                        addMessage('bot', data.answer);
                    } else {
                        addMessage('bot', 'Error fetching specials. Please try again.');
                    }
                } catch (error) {
                    typingIndicator.classList.remove('active');
                    addMessage('bot', 'Error fetching specials. Please try again.');
                }

                sendBtn.disabled = false;
                scrollToBottom();
                return;
            }

            // Check for order intent
            const orderKeywords = ['order', 'buy', 'purchase', 'want', 'get me', 'eat', 'have'];
            const hasOrderIntent = orderKeywords.some(keyword => message.toLowerCase().includes(keyword));

            // If user has items in cart and types a short message (likely an item name), treat it as order intent
            const isShortItemName = chatbotCart.length > 0 && message.split(' ').length <= 3 && message.length < 30;
            if ((hasOrderIntent || isShortItemName) && !currentOrderSession) {
                // Check if user is authenticated
                if (!isAuthenticated) {
                    addMessage('bot', 'üîí Please login to place an order. You can create an account or login to continue.');
                    // Add login / signup buttons
                    const loginCard = document.createElement('div');
                    loginCard.className = 'message bot';
                    loginCard.innerHTML = `
        <div class="message-avatar">üç∞</div>
        <div class="message-content">
            <div class="suggested-actions">
                <button class="suggested-action" onclick="window.location.href='/login/'">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <button class="suggested-action" onclick="window.location.href='/signin/'">
                    <i class="fas fa-user-plus"></i> Sign Up
                </button>
            </div>
        </div>
        `;
                    chatMessages.appendChild(loginCard);
                    scrollToBottom();
                    sendBtn.disabled = false;
                    return;
                }

                await handleOrderSearch(message);
                return;
            }

            // Show typing indicator
            typingIndicator.classList.add('active');
            scrollToBottom();

            // Disable send button
            sendBtn.disabled = true;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ query: message })
                });

                const data = await response.json();

                // Hide typing indicator
                typingIndicator.classList.remove('active');

                if (data.status === 'success') {
                    addMessage('bot', data.answer);

                    // Check if answer mentions products
                    if (data.answer.toLowerCase().includes('cake') ||
                        data.answer.toLowerCase().includes('bread') ||
                        data.answer.toLowerCase().includes('pastry')) {
                        addSuggestedActions();
                    }
                } else {
                    addMessage('bot', 'Sorry, I encountered an error. Please try again.', true);
                }

            } catch (error) {
                console.error('Error:', error);
                typingIndicator.classList.remove('active');
                addMessage('bot', 'Unable to connect. Please check your connection and try again.', true);
            } finally {
                sendBtn.disabled = false;
                scrollToBottom();
            }
        }

        // Add message to chat
        function addMessage(type, content, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const time = new Date().toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });

            if (type === 'bot') {
                messageDiv.innerHTML = `
        <div class="message-avatar">üç∞</div>
        <div class="message-content">
            <div class="message-bubble ${isError ? 'error-message' : ''}">
                ${content}
            </div>
            <div class="message-time">${time}</div>
        </div>
        `;
            } else {
                messageDiv.innerHTML = `
        <div class="message-content">
            <div class="message-bubble">${content}</div>
            <div class="message-time">${time}</div>
        </div>
        <div class="message-avatar">üë§</div>
        `;
            }

            chatMessages.appendChild(messageDiv);
            messageHistory.push({ type, content, time });
            scrollToBottom();
        }

        // Add suggested actions
        function addSuggestedActions() {
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'suggested-actions';
            actionsDiv.innerHTML = `
        <button class="suggested-action" onclick="window.location.href='/menu/'">
            <i class="fas fa-utensils"></i> View Menu
        </button>
        <button class="suggested-action" onclick="sendQuickMessage('Tell me more about cakes')">
            <i class="fas fa-info-circle"></i> Learn More
        </button>
        <button class="suggested-action" onclick="sendQuickMessage('What are your prices?')">
            <i class="fas fa-dollar-sign"></i> Check Prices
        </button>
        `;

            const lastMessage = chatMessages.querySelector('.message.bot:last-child .message-content');
            if (lastMessage) {
                lastMessage.appendChild(actionsDiv);
            }
        }

        // Scroll to bottom
        function scrollToBottom() {
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        // Show notification (can be triggered by events)
        function showChatNotification() {
            if (!chatbotContainer.classList.contains('active')) {
                chatNotification.style.display = 'flex';
            }
        }

        // ========================================
        // ORDER PLACEMENT FUNCTIONALITY
        // ========================================

        // Handle order search
        async function handleOrderSearch(message) {
            console.log('üîç handleOrderSearch called with:', message);
            console.log('üìã pendingOrderConfirmation:', pendingOrderConfirmation);

            // Check if this is a confirmation response for pending order
            if (pendingOrderConfirmation) {
                const lowerMsg = message.toLowerCase().trim();
                console.log('‚úÖ Checking confirmation. User said:', lowerMsg);

                if (lowerMsg === 'yes' || lowerMsg === 'y' || lowerMsg === 'yeah' || lowerMsg === 'yep' || lowerMsg ===
                    'confirm') {
                    // User confirmed - proceed with the pending order
                    const pending = pendingOrderConfirmation;
                    console.log('‚úÖ Confirmed! Searching for:', pending.itemName, 'qty:', pending.quantity);
                    pendingOrderConfirmation = null;
                    await searchAndDisplayItems(pending.itemName, pending.quantity);
                    return;
                } else if (lowerMsg === 'no' || lowerMsg === 'n' || lowerMsg === 'nope' || lowerMsg === 'cancel') {
                    // User declined
                    console.log('‚ùå User declined order');
                    pendingOrderConfirmation = null;
                    addMessage('bot', '‚ùå Order cancelled. What else can I help you with?');
                    return;
                } else {
                    // Invalid response - ask again
                    console.log('‚ö†Ô∏è Invalid response for confirmation');
                    addMessage('bot', `ü§î Do you mean **${pendingOrderConfirmation.quantity}x
        ${pendingOrderConfirmation.itemName}**?\n\nPlease reply "yes" to confirm or "no" to cancel.`);
                    return;
                }
            }

            typingIndicator.classList.add('active');
            sendBtn.disabled = true;

            // Extract quantity and item name from message
            let quantity = 1;
            let itemName = message;

            console.log('üîç Starting quantity extraction from:', message);

            // Pattern 1:"3 fruittart" or "5 cakes" (quantity first)
            const quantityFirstPattern = /^(\d+)\s+(.+)$/i;
            const quantityFirstMatch = message.match(quantityFirstPattern);

            // Pattern 2:"fruittart 3" or "cakes 5" (quantity last)
            const quantityLastPattern = /^(.+?)\s+(\d+)$/i;
            const quantityLastMatch = message.match(quantityLastPattern);

            // Pattern 3:"order 3 fruittart", "eat 4 cakes", "have 2 cookies"
            const orderPatterns = [
                /(?:order|buy|purchase|get|eat|have)\s+(\d+)\s+(.+)/i,
                /(?:order|buy|purchase|get|eat|have)\s+(?:me\s+)?(\d+)\s+(.+)/i,
                /(?:i want|i need|i'd like)\s+(?:to\s+)?(?:order|eat|have|buy)?\s*(\d+)\s+(.+)/i,
            ];

            let foundQuantity = false;

            // Check order patterns first (most specific)
            for (const pattern of orderPatterns) {
                const match = message.match(pattern);
                if (match) {
                    quantity = parseInt(match[1]);
                    itemName = match[2].trim();
                    foundQuantity = true;
                    break;
                }
            }

            // If not found, check quantity-first pattern
            // If not found, check quantity-first pattern
            if (!foundQuantity && quantityFirstMatch) {
                const parsedQty = parseInt(quantityFirstMatch[1]);
                const extractedItem = quantityFirstMatch[2].trim();

                // Only accept if quantity is reasonable (1-100)
                if (parsedQty >= 1 && parsedQty <= 100) {
                    quantity = parsedQty;
                    itemName = extractedItem;
                    foundQuantity = true;
                }
            }

            // If still not found, check quantity-last pattern
            if (!foundQuantity && quantityLastMatch) {
                const extractedItem = quantityLastMatch[1].trim();
                const parsedQty = parseInt(quantityLastMatch[2]);
                // Only accept if quantity is reasonable (1-100)
                if (parsedQty >= 1 && parsedQty <= 100) {
                    quantity = parsedQty;
                    itemName = extractedItem;
                    foundQuantity = true;
                }
            }

            // If no quantity found, try generic patterns to extract item name
            if (!foundQuantity) {
                const genericPatterns = [
                    /(?:can you|could you|please)\s+(?:order|get|buy)\s+(?:me\s+)?(?:a\s+|an\s+|some\s+|the\s+)?(.+)/i,
                    /(?:order|buy|purchase|get)\s+(?:me\s+)?(?:a\s+|an\s+|some\s+|the\s+)?(.+)/i,
                    /(?:i want|i need|i'd like)\s+(?:to\s+)?(?:order|eat|have|buy|get|try)\s+(?:a\s+|an\s+|some\s+|the\s+)?(.+)/i,
                    /(?:want|need)\s+(?:to\s+)?(?:order|eat|have|buy|get|try)?\s*(?:a\s+|an\s+|some\s+|the\s+)?(.+)/i
                ];
                for (const pattern of genericPatterns) {
                    const match = message.match(pattern);
                    if (match && match[1]) {
                        itemName = match[1].trim();
                        break;
                    }
                }
            }

            console.log('üìä Extraction results - Quantity:', quantity, 'Item:', itemName, 'Found explicit quantity:', foundQuantity);

            // If quantity was found, ask for confirmation
            if (foundQuantity && quantity > 1) {
                console.log('‚ùì Asking for confirmation (qty > 1)');
                typingIndicator.classList.remove('active');
                sendBtn.disabled = false;

                // Store pending confirmation
                pendingOrderConfirmation = {
                    quantity: quantity,
                    itemName: itemName
                };

                addMessage('bot', `ü§î Do you mean **${quantity}x ${itemName}**?\n\nPlease reply "yes" to confirm or "no" to cancel.`);
                scrollToBottom();
                return;
            }

            // Proceed with search
            await searchAndDisplayItems(itemName, quantity);
        }

        // Helper function to search and display items
        async function searchAndDisplayItems(itemName, quantity = 1) {
            console.log('üîé searchAndDisplayItems called with:', itemName, 'qty:', quantity);
            typingIndicator.classList.add('active');
            sendBtn.disabled = true;

            try {
                console.log('üì° Fetching from API...');
                const response = await fetch('/api/chatbot/order/search/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ query: itemName })
                });

                const data = await response.json();
                console.log('üì¶ API Response:', data);
                typingIndicator.classList.remove('active');

                if (data.found && data.items.length > 0) {
                    if (quantity > 1) {
                        addMessage('bot', `${data.message} (Quantity: ${quantity})`);
                    } else {
                        addMessage('bot', data.message);
                    }
                    displayMenuItems(data.items, quantity);
                } else {
                    addMessage('bot', data.message || 'Item not found. What else can I help you with?');
                }

            } catch (error) {
                console.error('‚ùå Error in searchAndDisplayItems:', error);
                typingIndicator.classList.remove('active');
                addMessage('bot', 'Error searching for items. Please try again.');
            } finally {
                sendBtn.disabled = false;
                scrollToBottom();
            }
        }

        // Display menu items as cards
        function displayMenuItems(items, suggestedQuantity = 1) {
            items.forEach(item => {
                const productCard = document.createElement('div');
                productCard.className = 'message bot';
                productCard.innerHTML = `
                <div class="message-avatar">üç∞</div>
                <div class="message-content">
                    <div class="product-card">
                        ${item.image_url ? `<img src="${item.image_url}" alt="${item.name}">` : ''}
                        <div class="product-info">
                            <h4>${item.name}</h4>
                            <p>${item.description || item.category}</p>
                            <div class="product-price">‚Çπ${item.price.toFixed(2)} each</div>
                        </div>
                        <div class="product-actions">
                            <div style="display: flex; align-items: center; gap: 10px; justify-content: center;">
                                <label style="font-weight: 600;">Quantity:</label>
                                <select id="qty-${item.id}"
                                    style="padding: 8px 12px; border-radius: 8px; border: 1px solid #e0e0e0; font-size: 14px; min-width: 60px;">
                                    <option value="1" ${suggestedQuantity === 1 ? 'selected' : ''}>1</option>
                                    <option value="2" ${suggestedQuantity === 2 ? 'selected' : ''}>2</option>
                                    <option value="3" ${suggestedQuantity === 3 ? 'selected' : ''}>3</option>
                                    <option value="4" ${suggestedQuantity === 4 ? 'selected' : ''}>4</option>
                                    <option value="5" ${suggestedQuantity === 5 ? 'selected' : ''}>5</option>
                                    <option value="6" ${suggestedQuantity === 6 ? 'selected' : ''}>6</option>
                                    <option value="7" ${suggestedQuantity === 7 ? 'selected' : ''}>7</option>
                                    <option value="8" ${suggestedQuantity === 8 ? 'selected' : ''}>8</option>
                                    <option value="9" ${suggestedQuantity === 9 ? 'selected' : ''}>9</option>
                                    <option value="10" ${suggestedQuantity === 10 ? 'selected' : ''}>10</option>
                                </select>
                            </div>
                            <button class="btn-order" onclick="addToCart(${item.id}, '${item.name}', ${item.price})">
                                <i class="fas fa-shopping-cart"></i> Add to Cart
                            </button>
                            <button class="btn-view" onclick="window.location.href='/menu/'">
                                <i class="fas fa-eye"></i> View Full Menu
                            </button>
                        </div>
                    </div>
                </div>
                `;
                chatMessages.appendChild(productCard);
            });
            scrollToBottom();
        }

        // Add item to cart
        function addToCart(itemId, itemName, price) {
            // Check authentication
            if (!isAuthenticated) {
                addMessage('bot', 'üîí Please login to place an order.');

                const loginCard = document.createElement('div');
                loginCard.className = 'message bot';
                loginCard.innerHTML = `
                <div class="message-avatar">üç∞</div>
                <div class="message-content">
                    <div class="suggested-actions">
                        <button class="suggested-action" onclick="window.location.href='/login/'">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                        <button class="suggested-action" onclick="window.location.href='/signin/'">
                            <i class="fas fa-user-plus"></i> Sign Up
                        </button>
                    </div>
                </div>
                `;
                chatMessages.appendChild(loginCard);
                scrollToBottom();
                return;
            }

            // Get selected quantity
            const qtySelector = document.getElementById(`qty-${itemId}`);
            const quantity = parseInt(qtySelector.value);

            // Check if item already in cart
            const existingItemIndex = chatbotCart.findIndex(item => item.id === itemId);

            if (existingItemIndex >= 0) {
                // Update quantity
                chatbotCart[existingItemIndex].quantity += quantity;
                addMessage('bot', `‚úÖ Updated ${itemName} quantity to ${chatbotCart[existingItemIndex].quantity}!`);
            } else {
                // Add new item
                chatbotCart.push({
                    id: itemId,
                    name: itemName,
                    price: price,
                    quantity: quantity
                });
                addMessage('bot', `‚úÖ Added ${quantity}x ${itemName} to your cart!`);
            }

            // Show cart summary and ask if they want more
            showCartOptions();
        }

        // Show cart options after adding item
        function showCartOptions() {
            const cartCard = document.createElement('div');
            cartCard.className = 'message bot';
            cartCard.innerHTML = `
                <div class="message-avatar">üç∞</div>
                <div class="message-content">
                    <div class="suggested-actions">
                        <button class="suggested-action" onclick="showCartSummary()">
                            <i class="fas fa-shopping-cart"></i> View Cart (${chatbotCart.length} item(s))
                        </button>
                        <button class="suggested-action" onclick="continueShoppingFromCart()">
                            <i class="fas fa-plus"></i> Add More Items
                        </button>
                        <button class="suggested-action" onclick="proceedToCheckout()">
                            <i class="fas fa-credit-card"></i> Checkout Now
                        </button>
                    </div>
                </div>
                `;
            chatMessages.appendChild(cartCard);
            scrollToBottom();
        }

        // Continue shopping
        function continueShoppingFromCart() {
            addMessage('user', 'Show me more items');
            addMessage('bot', 'What else would you like to order? You can ask for items like "I want Red Velvet Cake" or "Show me your menu"');
        }

        // Show cart summary
        function showCartSummary() {
            if (chatbotCart.length === 0) {
                addMessage('bot', 'üõí Your cart is empty. Start by ordering something!');
                return;
            }

            let cartSummary = 'üõí **Your Cart:**\\n\\n';
            let total = 0;

            chatbotCart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                cartSummary += `${index + 1}. ${item.name} - ${item.quantity}x ‚Çπ${item.price.toFixed(2)} = ‚Çπ${itemTotal.toFixed(2)}\\n`;
            });

            const deliveryFee = 50.00;
            const grandTotal = total + deliveryFee;

            cartSummary += `\\n**Subtotal:** ‚Çπ${total.toFixed(2)}\\n`;
            cartSummary += `**Delivery Fee:** ‚Çπ${deliveryFee.toFixed(2)}\\n`;
            cartSummary += `**Grand Total:** ‚Çπ${grandTotal.toFixed(2)}`;

            addMessage('bot', cartSummary);
            showCartOptions();
        }

        // Proceed to checkout with cart items
        async function proceedToCheckout() {
            if (chatbotCart.length === 0) {
                addMessage('bot', '‚ùå Your cart is empty. Please add items before checkout.');
                return;
            }

            addMessage('bot', 'üì¶ Great! Let\'s proceed with your order. Please provide your delivery details.');
            orderStep = 'address';
            addAddressForm();
        }

        // Initiate order (keeping for backward compatibility, but now redirects to cart)
        async function initiateOrder(itemId, itemName, price, quantity = 1) {
            // Check authentication
            if (!isAuthenticated) {
                addMessage('bot', 'üîí Please login to place an order.');

                const loginCard = document.createElement('div');
                loginCard.className = 'message bot';
                loginCard.innerHTML = `
                <div class="message-avatar">üç∞</div>
                <div class="message-content">
                    <div class="suggested-actions">
                        <button class="suggested-action" onclick="window.location.href='/login/'">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                        <button class="suggested-action" onclick="window.location.href='/signin/'">
                            <i class="fas fa-user-plus"></i> Sign Up
                        </button>
                    </div>
                </div>
                `;
                chatMessages.appendChild(loginCard);
                scrollToBottom();
                return;
            }

            typingIndicator.classList.add('active');
            sendBtn.disabled = true;

            try {
                const response = await fetch('/api/chatbot/order/initiate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        item_id: itemId,
                        quantity: quantity,
                        user_id: isAuthenticated ? "{{ user.id }}" : null
                    })
                });

                const data = await response.json();
                typingIndicator.classList.remove('active');

                if (data.success) {
                    currentOrderSession = data.session_id;
                    orderStep = 'address';

                    addMessage('bot', data.message);
                    addMessage('bot', `üì¶ Order Summary:\n‚Ä¢ Item: ${data.item.name}\n‚Ä¢ Quantity: ${data.item.quantity}\n‚Ä¢
                Price: ‚Çπ${data.item.item_total.toFixed(2)}\n‚Ä¢ Delivery Fee: ‚Çπ${data.item.delivery_fee.toFixed(2)}\n‚Ä¢
                Total: ‚Çπ${data.item.grand_total.toFixed(2)}\n\nüìç Please provide your delivery address and phone
                number.`);

                    // Add address input form
                    addAddressForm();
                } else {
                    addMessage('bot', data.message || 'Could not initiate order. Please try again.');
                }

            } catch (error) {
                typingIndicator.classList.remove('active');
                addMessage('bot', 'Error initiating order. Please try again.');
            } finally {
                sendBtn.disabled = false;
                scrollToBottom();
            }
        }

        // Add address form
        function addAddressForm() {
            const formCard = document.createElement('div');
            formCard.className = 'message bot';
            formCard.innerHTML = `
                <div class="message-avatar">üç∞</div>
                <div class="message-content">
                    <div class="product-card" style="flex-direction: column;">
                        <input type="text" id="deliveryAddress" placeholder="Enter full delivery address"
                            style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <input type="tel" id="deliveryPhone" placeholder="Phone number"
                            style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <button class="btn-order" onclick="submitAddress()" style="width: 100%; margin-top: 10px;">
                            <i class="fas fa-check"></i> Confirm Address
                        </button>
                    </div>
                </div>
                `;
            chatMessages.appendChild(formCard);
            scrollToBottom();
        }

        // Submit address
        async function submitAddress() {
            const address = document.getElementById('deliveryAddress').value.trim();
            const phone = document.getElementById('deliveryPhone').value.trim();

            if (!address) {
                alert('Please enter a delivery address');
                return;
            }

            if (chatbotCart.length === 0) {
                addMessage('bot', '‚ùå Cart is empty. Please add items first.');
                return;
            }

            typingIndicator.classList.add('active');
            sendBtn.disabled = true;

            try {
                // Calculate totals from cart
                let itemsTotal = 0;
                chatbotCart.forEach(item => {
                    itemsTotal += item.price * item.quantity;
                });
                const deliveryFee = 50.00;
                const grandTotal = itemsTotal + deliveryFee;

                // Create order session with first item
                const firstItem = chatbotCart[0];

                const initResponse = await fetch('/api/chatbot/order/initiate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        item_id: firstItem.id,
                        quantity: firstItem.quantity,
                        user_id: isAuthenticated ? "{{ user.id }}" : null
                    })
                });

                const initData = await initResponse.json();
                if (!initData.success) {
                    typingIndicator.classList.remove('active');
                    addMessage('bot', 'Error creating order. Please try again.');
                    sendBtn.disabled = false;
                    return;
                }

                currentOrderSession = initData.session_id;

                // Submit address
                const addressResponse = await fetch('/api/chatbot/order/address/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        session_id: currentOrderSession,
                        address: address,
                        phone: phone
                    })
                });

                const addressData = await addressResponse.json();

                if (!addressData.success) {
                    typingIndicator.classList.remove('active');
                    addMessage('bot', addressData.message || 'Error processing address. Please try again.');
                    sendBtn.disabled = false;
                    return;
                }

                // Create Razorpay order
                const createResponse = await fetch('/api/chatbot/order/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        session_id: currentOrderSession
                    })
                });

                const createData = await createResponse.json();
                typingIndicator.classList.remove('active');

                if (createData.success) {
                    addMessage('user', `Address: ${address}\nPhone: ${phone}`);
                    addMessage('bot', '‚úÖ Delivery details saved!');

                    // Show full cart summary
                    let summaryText = 'üì¶ **Order Summary:**\n\n';
                    chatbotCart.forEach((item, index) => {
                        const itemTotal = item.price * item.quantity;
                        summaryText += `${index + 1}. ${item.name} - ${item.quantity}x ‚Çπ${item.price.toFixed(2)} =
                ‚Çπ${itemTotal.toFixed(2)}\n`;
                    });

                    summaryText += `\nüí∞ Subtotal: ‚Çπ${itemsTotal.toFixed(2)}`;
                    summaryText += `\nüöö Delivery: ‚Çπ${deliveryFee.toFixed(2)}`;
                    summaryText += `\nüí≥ **Grand Total: ‚Çπ${grandTotal.toFixed(2)}**`;
                    summaryText += `\n\nüìç ${address}`;
                    summaryText += `\nüìû ${phone}`;

                    addMessage('bot', summaryText);

                    // Store Razorpay details and show payment button
                    window.currentRazorpayOrder = {
                        order_id: createData.order_id,
                        razorpay_order_id: createData.razorpay_order_id,
                        razorpay_key_id: createData.razorpay_key_id,
                        amount: createData.amount,
                        currency: createData.currency
                    };

                    addPaymentButton();
                } else {
                    addMessage('bot', createData.message || 'Error creating order. Please try again.');
                }

            } catch (error) {
                console.error('Error:', error);
                typingIndicator.classList.remove('active');
                addMessage('bot', 'Error submitting order. Please try again.');
            } finally {
                sendBtn.disabled = false;
                scrollToBottom();
            }
        }

        // Handle address input from chat
        async function handleAddressInput(message) {
            // Parse address from message
            const lines = message.split('\n');
            const address = lines[0];
            const phone = lines[1] || '';

            await submitAddressFromChat(address, phone);
        }

        async function submitAddressFromChat(address, phone) {
            typingIndicator.classList.add('active');
            sendBtn.disabled = true;

            try {
                const response = await fetch('/api/chatbot/order/address/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        session_id: currentOrderSession,
                        address: address,
                        phone: phone
                    })
                });

                const data = await response.json();
                typingIndicator.classList.remove('active');

                if (data.success) {
                    orderStep = 'payment';
                    addMessage('bot', data.message);

                    const summary = data.order_summary;
                    const summaryText = `‚úÖ Order Summary:\n\nüì¶ ${summary.item_name} (${summary.quantity}x)\nüí∞ Total:
                ‚Çπ${summary.grand_total.toFixed(2)}\nüìç ${summary.delivery_address}`;

                    addMessage('bot', summaryText);
                    addPaymentButton();
                } else {
                    addMessage('bot', data.message || 'Please provide a valid address.');
                }

            } catch (error) {
                typingIndicator.classList.remove('active');
                addMessage('bot', 'Error processing address. Please try again.');
            } finally {
                sendBtn.disabled = false;
                scrollToBottom();
            }
        }

        // Add payment button
        function addPaymentButton() {
            const paymentCard = document.createElement('div');
            paymentCard.className = 'message bot';
            paymentCard.innerHTML = `
                <div class="message-avatar">üç∞</div>
                <div class="message-content">
                    <div class="product-card">
                        <div style="text-align: center; width: 100%;">
                            <p style="margin-bottom: 15px;">Ready to complete your order?</p>
                            <button class="btn-order" onclick="processPayment()"
                                style="width: 100%; padding: 12px; font-size: 16px;">
                                <i class="fas fa-credit-card"></i> Pay with Razorpay
                            </button>
                        </div>
                    </div>
                </div>
                `;
            chatMessages.appendChild(paymentCard);
            scrollToBottom();
        }

        // Process payment
        async function processPayment() {
            typingIndicator.classList.add('active');
            sendBtn.disabled = true;

            try {
                const response = await fetch('/api/chatbot/order/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ session_id: currentOrderSession })
                });

                const data = await response.json();
                typingIndicator.classList.remove('active');

                if (data.success) {
                    // Initialize Razorpay
                    const options = {
                        key: data.razorpay_key_id,
                        amount: data.amount,
                        currency: data.currency,
                        name: 'The Bake Story',
                        description: data.order_details.item_name,
                        order_id: data.razorpay_order_id,
                        handler: function (response) {
                            verifyPayment(response);
                        },
                        prefill: {
                            name: isAuthenticated ? '{{ user.first_name }} {{ user.last_name }}' : 'Guest',
                            email: isAuthenticated ? '{{ user.email }}' : '',
                            contact: data.order_details.delivery_address
                        },
                        theme: {
                            color: '#d2691e'
                        }
                    };

                    const rzp = new Razorpay(options);
                    rzp.open();

                    rzp.on('payment.failed', function (response) {
                        addMessage('bot', '‚ùå Payment failed. Please try again or contact support.');
                    });
                } else {
                    addMessage('bot', data.message || 'Could not create order. Please try again.');
                }

            } catch (error) {
                typingIndicator.classList.remove('active');
                addMessage('bot', 'Error processing payment. Please try again.');
            } finally {
                sendBtn.disabled = false;
                scrollToBottom();
            }
        }

        // Verify payment
        async function verifyPayment(paymentData) {
            typingIndicator.classList.add('active');

            try {
                console.log('Verifying payment:', paymentData);
                console.log('CSRF Token:', csrftoken);

                const response = await fetch('/api/chatbot/order/payment/verify/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        razorpay_order_id: paymentData.razorpay_order_id,
                        razorpay_payment_id: paymentData.razorpay_payment_id,
                        razorpay_signature: paymentData.razorpay_signature
                    })
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                // Try to parse JSON response
                let data;
                try {
                    const responseText = await response.text();
                    console.log('Response text:', responseText);
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    typingIndicator.classList.remove('active');
                    addMessage('bot', '‚ùå Invalid response from server. Please contact support.');
                    return;
                }

                typingIndicator.classList.remove('active');

                console.log('Payment verification response:', data);

                // Check if payment was successful
                if (response.ok && data.success) {
                    addMessage('bot', data.message);
                    addMessage('bot', `üéâ Order ID: ${data.order_id}\n‚è±Ô∏è Estimated Delivery:
                ${data.estimated_delivery}\n\nThank you for ordering from The Bake Story! Your delicious treats are on
                the way! üç∞`);

                    // Reset order flow
                    currentOrderSession = null;
                    orderStep = null;

                    // Add order tracking button
                    setTimeout(() => {
                        addOrderTrackingButton(data.order_id);
                    }, 1000);
                } else {
                    // Payment verification failed
                    const errorMsg = data.message || 'Payment verification failed. Please contact support.';
                    addMessage('bot', '‚ùå ' + errorMsg);

                    // If we have an order ID, show it
                    if (data.order_id) {
                        addMessage('bot', `Your order ID is: ${data.order_id}. Please save this for reference.`);
                    }

                    console.error('Payment verification failed:', data);
                }

            } catch (error) {
                typingIndicator.classList.remove('active');
                console.error('Error verifying payment:', error);
                console.error('Error details:', error.message, error.stack);
                addMessage('bot', '‚ùå An error occurred while processing your payment. Please contact support.');
            } finally {
                scrollToBottom();
            }
        }

        // Add order tracking button
        function addOrderTrackingButton(orderId) {
            const trackCard = document.createElement('div');
            trackCard.className = 'message bot';
            trackCard.innerHTML = `
                <div class="message-avatar">üç∞</div>
                <div class="message-content">
                    <div class="suggested-actions">
                        <button class="suggested-action" onclick="window.location.href='/orders/'">
                            <i class="fas fa-list"></i> View My Orders
                        </button>
                        <button class="suggested-action" onclick="sendQuickMessage('order again')">
                            <i class="fas fa-redo"></i> Order Again
                        </button>
                    </div>
                </div>
                `;
            chatMessages.appendChild(trackCard);
            scrollToBottom();
        }

        // Initial greeting when page loads
        setTimeout(() => {
            if (messageHistory.length === 0) {
                showChatNotification();
            }
        }, 3000);
    </script>

    <!-- Razorpay Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    {% block extra_js %}{% endblock %}
</body>

</html>
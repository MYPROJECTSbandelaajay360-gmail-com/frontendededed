{% extends 'bakery/driver_base.html' %}

{% block title %}Dashboard - Driver Panel{% endblock %}

{% block extra_css %}
<style>
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       DRIVER DASHBOARD ‚Äî Professional Redesign
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    /* Welcome Banner */
    .welcome-banner {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        border-radius: var(--radius);
        padding: 28px 32px;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
        position: relative;
        overflow: hidden;
    }
    .welcome-banner::after {
        content: '';
        position: absolute;
        right: -30px;
        top: -30px;
        width: 160px;
        height: 160px;
        background: rgba(255,255,255,0.08);
        border-radius: 50%;
    }
    .welcome-banner h2 { font-size: 22px; font-weight: 700; margin-bottom: 6px; }
    .welcome-banner p { opacity: 0.9; font-size: 14px; }
    .welcome-icon { font-size: 52px; opacity: 0.7; z-index: 1; }

    /* Stat Cards */
    .stat-card {
        padding: 20px 22px;
        display: flex;
        align-items: center;
        gap: 16px;
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        transition: var(--transition);
        border: 1px solid var(--border);
    }
    .stat-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
    .stat-icon {
        width: 50px; height: 50px; border-radius: var(--radius-sm);
        display: flex; align-items: center; justify-content: center;
        font-size: 20px; flex-shrink: 0;
    }
    .stat-icon.earnings { background: #fff7ed; color: var(--primary); }
    .stat-icon.completed { background: var(--success-bg); color: var(--success); }
    .stat-icon.pending { background: var(--warning-bg); color: var(--warning); }
    .stat-value { font-size: 26px; font-weight: 800; line-height: 1; color: var(--text); }
    .stat-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; font-weight: 500; }

    /* Section Title */
    .section-title {
        font-size: 16px; font-weight: 700; margin-bottom: 16px;
        display: flex; align-items: center; gap: 8px; color: var(--text);
    }
    .section-title i { color: var(--primary); }
    .section-title .count {
        background: var(--primary-bg); color: var(--primary);
        font-size: 12px; font-weight: 700; padding: 2px 10px;
        border-radius: 20px; margin-left: 8px;
    }

    /* Delivery Card */
    .delivery-card {
        padding: 20px; margin-bottom: 16px; background: var(--card);
        border-radius: var(--radius); box-shadow: var(--shadow);
        border: 1px solid var(--border); transition: var(--transition);
        position: relative; overflow: hidden;
    }
    .delivery-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
    .delivery-card.unassigned { border-left: 4px solid #f59e0b; }
    .delivery-card-top {
        display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px;
    }
    .delivery-order-id { font-weight: 700; font-size: 15px; color: var(--text); }
    .delivery-time { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
    .delivery-amount { font-weight: 800; font-size: 20px; color: var(--primary); }

    /* Info Grid */
    .delivery-info {
        background: #f8fafc; border-radius: var(--radius-sm); padding: 14px;
        margin-bottom: 16px; border: 1px solid var(--border);
    }
    .info-row {
        display: flex; align-items: flex-start; gap: 10px;
        font-size: 13px; margin-bottom: 8px;
    }
    .info-row:last-child { margin-bottom: 0; }
    .info-row i { color: var(--primary); margin-top: 3px; width: 16px; text-align: center; }
    .info-row .val { font-weight: 600; color: var(--text); flex: 1; line-height: 1.4; }

    /* Progress Track */
    .progress-track {
        display: flex; align-items: flex-start; gap: 0;
        margin-bottom: 16px; padding: 0 4px;
    }
    .progress-step {
        flex: 0 0 auto; display: flex; flex-direction: column; align-items: center;
    }
    .progress-dot {
        width: 16px; height: 16px; border-radius: 50%; background: #e2e8f0;
        border: 2px solid #e2e8f0; z-index: 1; transition: 0.3s;
    }
    .progress-dot.active {
        background: var(--primary); border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(232,89,12,0.15);
    }
    .progress-dot.done { background: var(--success); border-color: var(--success); }
    .progress-label {
        font-size: 10px; color: var(--text-secondary); margin-top: 6px;
        text-align: center; font-weight: 500; white-space: nowrap;
    }
    .progress-line {
        flex: 1; height: 3px; background: #e2e8f0;
        margin-top: 7px; min-width: 20px;
    }
    .progress-line.done { background: var(--success); }
    .progress-line.active { background: linear-gradient(90deg, var(--success), var(--primary)); }

    /* Action Buttons */
    .delivery-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn-action {
        padding: 8px 16px; border-radius: var(--radius-sm); font-size: 13px;
        font-weight: 600; border: none; cursor: pointer; display: inline-flex;
        align-items: center; gap: 6px; transition: var(--transition); text-decoration: none;
    }
    .btn-action.primary {
        background: var(--primary); color: #fff;
    }
    .btn-action.primary:hover { background: var(--primary-dark); }
    .btn-action.success { background: var(--success); color: #fff; }
    .btn-action.success:hover { background: #15803d; }
    .btn-action.outline {
        background: transparent; color: var(--text-secondary);
        border: 1px solid var(--border);
    }
    .btn-action.outline:hover { border-color: var(--primary); color: var(--primary); }

    /* Status Badges */
    .status-pill {
        display: inline-flex; align-items: center; gap: 5px;
        padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;
    }
    .status-pill.confirmed { background: var(--info-bg); color: var(--info); }
    .status-pill.preparing { background: #fef3c7; color: #d97706; }
    .status-pill.ready { background: #dbeafe; color: #2563eb; }
    .status-pill.picked_up { background: var(--warning-bg); color: var(--warning); }
    .status-pill.on_the_way { background: #e0e7ff; color: #4f46e5; }
    .status-pill.delivered, .status-pill.completed { background: var(--success-bg); color: var(--success); }

    /* Dashboard Grid */
    .dashboard-grid {
        display: grid; grid-template-columns: 1fr 380px; gap: 24px;
    }
    @media (max-width: 1100px) { .dashboard-grid { grid-template-columns: 1fr; } }

    /* Sidebar Card */
    .side-card {
        background: var(--card); border-radius: var(--radius);
        box-shadow: var(--shadow); border: 1px solid var(--border);
        margin-bottom: 20px; overflow: hidden;
    }
    .side-card-header {
        padding: 16px 20px; border-bottom: 1px solid var(--border);
        font-weight: 700; font-size: 14px; display: flex;
        justify-content: space-between; align-items: center;
    }
    .side-card-header i { color: var(--primary); margin-right: 8px; }
    .side-card-body { padding: 20px; }

    /* Map Container */
    .map-container {
        height: 220px; border-radius: 0; overflow: hidden;
        background: #e2e8f0; display: flex; align-items: center;
        justify-content: center; color: var(--text-secondary);
    }
    .map-container #dashboardMap { width: 100%; height: 100%; }

    /* Quick Actions */
    .quick-actions { display: flex; gap: 10px; padding: 16px 20px; }
    .quick-action-link {
        flex: 1; padding: 10px; border-radius: var(--radius-sm);
        border: 1px solid var(--border); background: var(--card);
        text-align: center; font-size: 13px; font-weight: 500;
        color: var(--text-secondary); text-decoration: none;
        transition: var(--transition); display: flex;
        align-items: center; justify-content: center; gap: 6px;
    }
    .quick-action-link:hover { border-color: var(--primary); color: var(--primary); }

    /* Empty State */
    .empty-state {
        padding: 60px 20px; text-align: center; background: var(--card);
        border-radius: var(--radius); border: 1px solid var(--border);
    }
    .empty-state .icon { font-size: 52px; margin-bottom: 16px; }
    .empty-state h3 { font-weight: 700; margin-bottom: 6px; color: var(--text); }
    .empty-state p { color: var(--text-secondary); font-size: 14px; }

    /* Live Tracking Banner */
    .tracking-banner {
        background: linear-gradient(135deg, #059669, #047857);
        border-radius: var(--radius-sm); padding: 14px 20px;
        color: #fff; display: flex; align-items: center;
        justify-content: space-between; margin-bottom: 16px;
    }
    .tracking-banner .pulse {
        width: 10px; height: 10px; border-radius: 50%; background: #34d399;
        animation: pulse 1.5s infinite; margin-right: 10px; display: inline-block;
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(52,211,153,0.5); }
        70% { box-shadow: 0 0 0 8px rgba(52,211,153,0); }
        100% { box-shadow: 0 0 0 0 rgba(52,211,153,0); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Welcome Banner -->
<div class="welcome-banner">
    <div>
        <h2>Welcome back, {{ user.first_name|default:user.username }}!</h2>
        <p>You have {{ delivery_count }} deliver{{ delivery_count|pluralize:"y,ies" }} today &middot; {{ pending_count }} pending</p>
    </div>
    <div class="welcome-icon">üöö</div>
</div>

<!-- Stats Row -->
<div class="grid-3" style="margin-bottom: 24px;">
    <div class="stat-card">
        <div class="stat-icon earnings"><i class="fas fa-rupee-sign"></i></div>
        <div>
            <div class="stat-value">‚Çπ{{ todays_earnings }}</div>
            <div class="stat-label">Today's Earnings</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon completed"><i class="fas fa-check-circle"></i></div>
        <div>
            <div class="stat-value">{{ completed_count }}</div>
            <div class="stat-label">Completed Today</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon pending"><i class="fas fa-clock"></i></div>
        <div>
            <div class="stat-value">{{ pending_count }}</div>
            <div class="stat-label">Pending Orders</div>
        </div>
    </div>
</div>

<!-- Main Dashboard Grid -->
<div class="dashboard-grid">
    <!-- LEFT COLUMN ‚Äî Active Deliveries -->
    <div>
        <!-- Active Delivery Tracking Banner -->
        {% for order in todays_orders %}
        {% if order.status == 'picked_up' or order.status == 'on_the_way' %}
        <div class="tracking-banner">
            <div style="display:flex;align-items:center;">
                <span class="pulse"></span>
                <div>
                    <div style="font-weight:700;font-size:14px;">Live Delivery ‚Äî Order #{{ order.id }}</div>
                    <div style="font-size:12px;opacity:0.9;">{{ order.delivery_address|truncatechars:50 }}</div>
                </div>
            </div>
            <a href="{% url 'driver_map' %}" class="btn-action outline" style="color:#fff;border-color:rgba(255,255,255,0.3);">
                <i class="fas fa-map-marker-alt"></i> Navigate
            </a>
        </div>
        {% endif %}
        {% endfor %}

        <div class="section-title">
            <i class="fas fa-box"></i> Today's Deliveries
            {% if todays_orders %}<span class="count">{{ todays_orders|length }}</span>{% endif %}
        </div>

        {% if todays_orders %}
        {% for order in todays_orders %}
        <div class="delivery-card">
            <div class="delivery-card-top">
                <div>
                    <div class="delivery-order-id">Order #{{ order.id }}</div>
                    <div class="delivery-time"><i class="fas fa-clock"></i> {{ order.created_at|timesince }} ago</div>
                </div>
                <div style="display:flex;align-items:center;gap:12px;">
                    <span class="status-pill {{ order.status }}">
                        {% if order.status == 'confirmed' %}<i class="fas fa-check"></i>
                        {% elif order.status == 'preparing' %}<i class="fas fa-fire"></i>
                        {% elif order.status == 'ready' %}<i class="fas fa-box"></i>
                        {% elif order.status == 'picked_up' %}<i class="fas fa-motorcycle"></i>
                        {% elif order.status == 'on_the_way' %}<i class="fas fa-route"></i>
                        {% elif order.status == 'delivered' or order.status == 'completed' %}<i class="fas fa-check-double"></i>
                        {% endif %}
                        {{ order.get_status_display }}
                    </span>
                    <div class="delivery-amount">‚Çπ{{ order.grand_total }}</div>
                </div>
            </div>

            <div class="delivery-info">
                <div class="info-row">
                    <i class="fas fa-user"></i>
                    <div class="val">{{ order.user.first_name|default:order.user.username }} {{ order.user.last_name|default:"" }}</div>
                </div>
                <div class="info-row">
                    <i class="fas fa-phone-alt"></i>
                    <div class="val">{{ order.delivery_phone|default:"N/A" }}</div>
                </div>
                <div class="info-row">
                    <i class="fas fa-map-marker-alt"></i>
                    <div class="val">{{ order.delivery_address|default:"Not provided" }}</div>
                </div>
                {% if order.delivery_notes %}
                <div class="info-row">
                    <i class="fas fa-sticky-note"></i>
                    <div class="val" style="color:var(--text-secondary);font-style:italic;">{{ order.delivery_notes }}</div>
                </div>
                {% endif %}
            </div>

            <!-- Order Items Preview -->
            <div style="margin-bottom:14px;">
                <div style="font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;">ORDER ITEMS</div>
                {% for item in order.items.all %}
                <div style="display:flex;align-items:center;gap:10px;padding:6px 0;{% if not forloop.last %}border-bottom:1px dashed var(--border);{% endif %}">
                    {% if item.menu_item.image_url %}
                    <img src="{{ item.menu_item.image_url }}" style="width:36px;height:36px;border-radius:6px;object-fit:cover;">
                    {% else %}
                    <div style="width:36px;height:36px;border-radius:6px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;color:#94a3b8;font-size:14px;"><i class="fas fa-utensils"></i></div>
                    {% endif %}
                    <div style="flex:1;">
                        <div style="font-size:13px;font-weight:600;">{{ item.menu_item.name }}</div>
                        <div style="font-size:11px;color:var(--text-secondary);">{{ item.quantity }} √ó ‚Çπ{{ item.price }}</div>
                    </div>
                    <div style="font-weight:700;font-size:13px;color:var(--primary);">‚Çπ{{ item.subtotal }}</div>
                </div>
                {% endfor %}
            </div>

            <!-- Progress Track -->
            <div class="progress-track">
                <div class="progress-step">
                    <div class="progress-dot {% if order.status == 'confirmed' or order.status == 'preparing' %}active{% elif order.status == 'ready' or order.status == 'picked_up' or order.status == 'on_the_way' or order.status == 'delivered' or order.status == 'completed' %}done{% endif %}"></div>
                    <div class="progress-label">Assigned</div>
                </div>
                <div class="progress-line {% if order.status == 'ready' or order.status == 'picked_up' or order.status == 'on_the_way' or order.status == 'delivered' or order.status == 'completed' %}done{% elif order.status == 'confirmed' or order.status == 'preparing' %}active{% endif %}"></div>
                <div class="progress-step">
                    <div class="progress-dot {% if order.status == 'ready' %}active{% elif order.status == 'picked_up' or order.status == 'on_the_way' or order.status == 'delivered' or order.status == 'completed' %}done{% endif %}"></div>
                    <div class="progress-label">Ready</div>
                </div>
                <div class="progress-line {% if order.status == 'picked_up' or order.status == 'on_the_way' or order.status == 'delivered' or order.status == 'completed' %}done{% elif order.status == 'ready' %}active{% endif %}"></div>
                <div class="progress-step">
                    <div class="progress-dot {% if order.status == 'picked_up' %}active{% elif order.status == 'on_the_way' or order.status == 'delivered' or order.status == 'completed' %}done{% endif %}"></div>
                    <div class="progress-label">Picked Up</div>
                </div>
                <div class="progress-line {% if order.status == 'on_the_way' or order.status == 'delivered' or order.status == 'completed' %}done{% elif order.status == 'picked_up' %}active{% endif %}"></div>
                <div class="progress-step">
                    <div class="progress-dot {% if order.status == 'on_the_way' %}active{% elif order.status == 'delivered' or order.status == 'completed' %}done{% endif %}"></div>
                    <div class="progress-label">En Route</div>
                </div>
                <div class="progress-line {% if order.status == 'delivered' or order.status == 'completed' %}done{% elif order.status == 'on_the_way' %}active{% endif %}"></div>
                <div class="progress-step">
                    <div class="progress-dot {% if order.status == 'delivered' or order.status == 'completed' %}done{% endif %}"></div>
                    <div class="progress-label">Delivered</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="delivery-actions">
                {% if order.status == 'confirmed' or order.status == 'preparing' or order.status == 'ready' %}
                <button class="btn-action primary" onclick="updateOrderStatus('{{ order.order_id }}', 'pickup')">
                    <i class="fas fa-motorcycle"></i> Mark Picked Up
                </button>
                {% elif order.status == 'picked_up' %}
                <button class="btn-action primary" onclick="updateOrderStatus('{{ order.order_id }}', 'on_the_way')">
                    <i class="fas fa-route"></i> Start Delivery
                </button>
                {% elif order.status == 'on_the_way' %}
                <button class="btn-action success" onclick="updateOrderStatus('{{ order.order_id }}', 'delivered')">
                    <i class="fas fa-check-double"></i> Mark Delivered
                </button>
                {% elif order.status == 'delivered' or order.status == 'completed' %}
                <span class="btn-action" style="color:var(--success);cursor:default;"><i class="fas fa-check-circle"></i> Delivered</span>
                {% endif %}
                <a href="{% url 'driver_map' %}" class="btn-action outline"><i class="fas fa-map-marker-alt"></i> Map</a>
                {% if order.delivery_phone %}
                <a href="tel:{{ order.delivery_phone }}" class="btn-action outline"><i class="fas fa-phone"></i> Call</a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% endif %}

        <!-- Unassigned Orders -->
        {% if unassigned_orders %}
        <div class="section-title" style="margin-top:28px;">
            <i class="fas fa-inbox"></i> Available for Pickup
            <span class="count">{{ unassigned_orders|length }}</span>
        </div>
        {% for order in unassigned_orders %}
        <div class="delivery-card unassigned">
            <div class="delivery-card-top">
                <div>
                    <div class="delivery-order-id">Order #{{ order.id }}</div>
                    <div class="delivery-time"><i class="fas fa-clock"></i> {{ order.created_at|timesince }} ago</div>
                </div>
                <div class="delivery-amount">‚Çπ{{ order.grand_total }}</div>
            </div>
            <div class="delivery-info">
                <div class="info-row">
                    <i class="fas fa-user"></i>
                    <div class="val">{{ order.user.first_name|default:order.user.username }} {{ order.user.last_name|default:"" }}</div>
                </div>
                <div class="info-row">
                    <i class="fas fa-map-marker-alt"></i>
                    <div class="val">{{ order.delivery_address|default:"Not provided" }}</div>
                </div>
            </div>
            <div style="margin-bottom:12px;font-size:12px;font-weight:600;color:var(--text-secondary);">
                {{ order.items.count }} item{{ order.items.count|pluralize:"s" }} &middot; {{ order.get_status_display }}
            </div>
            <button class="btn-action primary" onclick="updateOrderStatus('{{ order.order_id }}', 'accept')">
                <i class="fas fa-check"></i> Accept Delivery
            </button>
        </div>
        {% endfor %}
        {% endif %}

        {% if not todays_orders and not unassigned_orders %}
        <div class="empty-state">
            <div class="icon">üì¶</div>
            <h3>No Active Deliveries</h3>
            <p>New delivery orders will appear here when available.</p>
        </div>
        {% endif %}
    </div>

    <!-- RIGHT COLUMN ‚Äî Earnings + Map + Quick Actions -->
    <div>
        <!-- Earnings Summary -->
        <div class="side-card">
            <div class="side-card-header">
                <span><i class="fas fa-chart-line"></i> Earnings Summary</span>
                <a href="{% url 'driver_earnings' %}" style="font-size:12px;color:var(--primary);text-decoration:none;font-weight:600;">View All</a>
            </div>
            <div class="side-card-body">
                <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px;">
                    <div class="stat-icon earnings" style="width:56px;height:56px;font-size:24px;">
                        <i class="fas fa-rupee-sign"></i>
                    </div>
                    <div>
                        <div style="font-size:11px;color:var(--text-secondary);font-weight:500;">TODAY'S EARNINGS</div>
                        <div style="font-size:32px;font-weight:800;color:var(--text);">‚Çπ{{ todays_earnings }}</div>
                    </div>
                </div>
                <div style="display:flex;gap:12px;">
                    <div style="flex:1;padding:14px;background:var(--success-bg);border-radius:var(--radius-sm);text-align:center;">
                        <div style="font-size:22px;font-weight:800;color:var(--success);">{{ completed_count }}</div>
                        <div style="font-size:11px;color:var(--text-secondary);font-weight:500;">Completed</div>
                    </div>
                    <div style="flex:1;padding:14px;background:var(--warning-bg);border-radius:var(--radius-sm);text-align:center;">
                        <div style="font-size:22px;font-weight:800;color:var(--warning);">{{ pending_count }}</div>
                        <div style="font-size:11px;color:var(--text-secondary);font-weight:500;">Pending</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Preview -->
        <div class="side-card">
            <div class="side-card-header">
                <span><i class="fas fa-map"></i> Live Map</span>
                <a href="{% url 'driver_map' %}" class="btn-action outline" style="padding:4px 12px;font-size:12px;">Full Map</a>
            </div>
            <div class="map-container" id="dashboardMapContainer">
                <span><i class="fas fa-spinner fa-spin"></i> Loading map...</span>
            </div>
            <div class="quick-actions">
                <a href="{% url 'driver_map' %}" class="quick-action-link">
                    <i class="fas fa-route"></i> Navigate
                </a>
                <a href="{% url 'driver_orders' %}" class="quick-action-link">
                    <i class="fas fa-clipboard-list"></i> All Orders
                </a>
            </div>
        </div>

        <!-- Performance Today -->
        <div class="side-card">
            <div class="side-card-header">
                <span><i class="fas fa-bolt"></i> Quick Stats</span>
            </div>
            <div class="side-card-body" style="padding:16px 20px;">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);">
                    <span style="font-size:13px;color:var(--text-secondary);"><i class="fas fa-truck" style="width:20px;color:var(--primary);"></i> Total Deliveries</span>
                    <span style="font-weight:700;font-size:15px;">{{ delivery_count }}</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);">
                    <span style="font-size:13px;color:var(--text-secondary);"><i class="fas fa-check-circle" style="width:20px;color:var(--success);"></i> Completed</span>
                    <span style="font-weight:700;font-size:15px;color:var(--success);">{{ completed_count }}</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;">
                    <span style="font-size:13px;color:var(--text-secondary);"><i class="fas fa-inbox" style="width:20px;color:#f59e0b;"></i> Available</span>
                    <span style="font-weight:700;font-size:15px;color:#f59e0b;">{{ unassigned_orders|length }}</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ‚îÄ‚îÄ GPS Location Tracking ‚îÄ‚îÄ
    let watchId = null;
    function startLocationTracking() {
        if (!navigator.geolocation) return;
        watchId = navigator.geolocation.watchPosition(
            function(pos) {
                fetch('{% url "driver_location" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        heading: pos.coords.heading || 0,
                        speed: pos.coords.speed ? (pos.coords.speed * 3.6).toFixed(1) : 0
                    })
                });
            },
            function(err) { console.warn('Location error:', err.message); },
            { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
        );
    }
    startLocationTracking();

    // ‚îÄ‚îÄ Dashboard Map ‚îÄ‚îÄ
    {% if GOOGLE_MAPS_API_KEY %}
    function initDashMap() {
        const mapEl = document.getElementById('dashboardMapContainer');
        mapEl.innerHTML = '<div id="dashboardMap"></div>';
        document.getElementById('dashboardMap').style.cssText = 'width:100%;height:100%;';

        const defaultCenter = { lat: 17.3616, lng: 78.4747 };

        const map = new google.maps.Map(document.getElementById('dashboardMap'), {
            center: defaultCenter,
            zoom: 14,
            disableDefaultUI: true,
            zoomControl: true,
            styles: [
                { featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] },
                { featureType: 'transit', stylers: [{ visibility: 'off' }] }
            ]
        });

        // Show driver's current position
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(pos) {
                const driverPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                map.setCenter(driverPos);
                new google.maps.Marker({
                    position: driverPos,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: '#e8590c',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 3,
                    },
                    title: "Your Location"
                });
            });
        }
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initDashMap" async defer></script>
{% else %}
<script>
    document.getElementById('dashboardMapContainer').innerHTML =
        '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-secondary);">' +
        '<i class="fas fa-map" style="font-size:32px;margin-bottom:8px;color:var(--primary);"></i>' +
        '<span style="font-size:13px;">Google Maps API key not configured</span></div>';
</script>
{% endif %}

<script>
    // ‚îÄ‚îÄ Auto-refresh dashboard every 30 seconds ‚îÄ‚îÄ
    setInterval(function() {
        fetch('{% url "driver_stats_api" %}')
            .then(r => r.json())
            .then(data => {
                // Update stat values if elements exist
                const statValues = document.querySelectorAll('.stat-value');
                if (statValues.length >= 3) {
                    statValues[0].textContent = '‚Çπ' + data.todays_earnings;
                    statValues[1].textContent = data.completed_count;
                    statValues[2].textContent = data.pending_count;
                }
            })
            .catch(() => {});
    }, 30000);
</script>
{% endblock %}